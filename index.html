<!DOCTYPE html>
<html lang="ru">
<head>
Â  Â  <meta charset="UTF-8">
Â  Â  <meta name="viewport" content="width=device-width, initial-scale=1.0">
Â  Â  <title>Telegram Web App Store</title>
Â  Â  <script src="https://telegram.org/js/telegram-web-app.js"></script>
Â  Â  
Â  Â  <style>
Â  Â  Â  Â  /* Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ Ğ¿ĞµÑ€ĞµĞ¼ĞµĞ½Ğ½Ñ‹Ñ… Ñ†Ğ²ĞµÑ‚Ğ¾Ğ² Telegram */
Â  Â  Â  Â  :root {
Â  Â  Â  Â  Â  Â  --bg-color: var(--tg-theme-bg-color, #ffffff);
Â  Â  Â  Â  Â  Â  --secondary-bg-color: var(--tg-theme-secondary-bg-color, #f4f4f5);
Â  Â  Â  Â  Â  Â  --text-color: var(--tg-theme-text-color, #000000);
Â  Â  Â  Â  Â  Â  --hint-color: var(--tg-theme-hint-color, #999999);
Â  Â  Â  Â  Â  Â  --button-color: var(--tg-theme-button-color, #5375c3);
Â  Â  Â  Â  Â  Â  --button-text-color: var(--tg-theme-button-text-color, #ffffff);
Â  Â  Â  Â  Â  Â  --link-color: var(--tg-theme-link-color, #2b84ff);
Â  Â  Â  Â  }

Â  Â  Â  Â  body {
Â  Â  Â  Â  Â  Â  font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen, Ubuntu, Cantarell, "Fira Sans", "Droid Sans", "Helvetica Neue", sans-serif;
Â  Â  Â  Â  Â  Â  margin: 0;
Â  Â  Â  Â  Â  Â  padding: 10px;
Â  Â  Â  Â  Â  Â  background-color: var(--bg-color);
Â  Â  Â  Â  Â  Â  color: var(--text-color);
Â  Â  Â  Â  Â  Â  transition: background-color 0.3s;
Â  Â  Â  Â  }

Â  Â  Â  Â  h2 {
Â  Â  Â  Â  Â  Â  color: var(--text-color);
Â  Â  Â  Â  Â  Â  margin-bottom: 20px;
Â  Â  Â  Â  Â  Â  text-align: center;
Â  Â  Â  Â  }

Â  Â  Â  Â  /* --- ĞšĞ°Ñ‚Ğ°Ğ»Ğ¾Ğ³ --- */
Â  Â  Â  Â  #catalog, #cart-view {
Â  Â  Â  Â  Â  Â  padding: 10px 0;
Â  Â  Â  Â  }

Â  Â  Â  Â  .catalog-grid {
Â  Â  Â  Â  Â  Â  display: grid;
Â  Â  Â  Â  Â  Â  grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
Â  Â  Â  Â  Â  Â  gap: 15px;
Â  Â  Â  Â  }

Â  Â  Â  Â  .product-item {
Â  Â  Â  Â  Â  Â  background-color: var(--secondary-bg-color);
Â  Â  Â  Â  Â  Â  border-radius: 12px;
Â  Â  Â  Â  Â  Â  overflow: hidden;
Â  Â  Â  Â  Â  Â  text-align: center;
Â  Â  Â  Â  Â  Â  box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
Â  Â  Â  Â  Â  Â  display: flex;
Â  Â  Â  Â  Â  Â  flex-direction: column;
Â  Â  Â  Â  }

Â  Â  Â  Â  .product-image {
Â  Â  Â  Â  Â  Â  width: 100%;
Â  Â  Â  Â  Â  Â  height: 120px;
Â  Â  Â  Â  Â  Â  object-fit: cover;
Â  Â  Â  Â  Â  Â  background-color: #ccc;
Â  Â  Â  Â  Â  Â  border-bottom: 1px solid rgba(0, 0, 0, 0.05);
Â  Â  Â  Â  }

Â  Â  Â  Â  .product-info {
Â  Â  Â  Â  Â  Â  padding: 10px;
Â  Â  Â  Â  Â  Â  flex-grow: 1;
Â  Â  Â  Â  Â  Â  display: flex;
Â  Â  Â  Â  Â  Â  flex-direction: column;
Â  Â  Â  Â  Â  Â  justify-content: space-between;
Â  Â  Â  Â  }
Â  Â  Â  Â  
Â  Â  Â  Â  .product-info h3 {
Â  Â  Â  Â  Â  Â  font-size: 16px;
Â  Â  Â  Â  Â  Â  margin: 0 0 5px;
Â  Â  Â  Â  }
Â  Â  Â  Â  
Â  Â  Â  Â  .product-description {
Â  Â  Â  Â  Â  Â  font-size: 12px;
Â  Â  Â  Â  Â  Â  color: var(--hint-color);
Â  Â  Â  Â  Â  Â  margin: 0 0 10px;
Â  Â  Â  Â  Â  Â  line-height: 1.3;
Â  Â  Â  Â  }

Â  Â  Â  Â  .product-price {
Â  Â  Â  Â  Â  Â  font-weight: bold;
Â  Â  Â  Â  Â  Â  color: var(--text-color);
Â  Â  Â  Â  Â  Â  font-size: 18px;
Â  Â  Â  Â  Â  Â  margin: 5px 0 10px;
Â  Â  Â  Â  }

Â  Â  Â  Â  .add-to-cart-btn {
Â  Â  Â  Â  Â  Â  background-color: var(--button-color);
Â  Â  Â  Â  Â  Â  color: var(--button-text-color);
Â  Â  Â  Â  Â  Â  border: none;
Â  Â  Â  Â  Â  Â  padding: 8px 15px;
Â  Â  Â  Â  Â  Â  border-radius: 8px;
Â  Â  Â  Â  Â  Â  cursor: pointer;
Â  Â  Â  Â  Â  Â  font-size: 14px;
Â  Â  Â  Â  Â  Â  width: 100%;
Â  Â  Â  Â  Â  Â  margin-top: auto; /* ĞŸÑ€Ğ¸Ğ¶Ğ¸Ğ¼Ğ°ĞµÑ‚ ĞºĞ½Ğ¾Ğ¿ĞºÑƒ Ğº Ğ½Ğ¸Ğ·Ñƒ */
Â  Â  Â  Â  }
Â  Â  Â  Â  
Â  Â  Â  Â  /* --- ĞšĞ¾Ñ€Ğ·Ğ¸Ğ½Ğ° --- */
Â  Â  Â  Â  .cart-item {
Â  Â  Â  Â  Â  Â  display: flex;
Â  Â  Â  Â  Â  Â  justify-content: space-between;
Â  Â  Â  Â  Â  Â  align-items: center;
Â  Â  Â  Â  Â  Â  padding: 10px;
Â  Â  Â  Â  Â  Â  margin-bottom: 8px;
Â  Â  Â  Â  Â  Â  background-color: var(--secondary-bg-color);
Â  Â  Â  Â  Â  Â  border-radius: 8px;
Â  Â  Â  Â  }
Â  Â  Â  Â  
Â  Â  Â  Â  .cart-item-info {
Â  Â  Â  Â  Â  Â  flex-grow: 1;
Â  Â  Â  Â  Â  Â  padding-right: 10px;
Â  Â  Â  Â  }
Â  Â  Â  Â  
Â  Â  Â  Â  .cart-item-controls {
Â  Â  Â  Â  Â  Â  display: flex;
Â  Â  Â  Â  Â  Â  align-items: center;
Â  Â  Â  Â  Â  Â  gap: 5px;
Â  Â  Â  Â  }
Â  Â  Â  Â  
Â  Â  Â  Â  .qty-btn {
Â  Â  Â  Â  Â  Â  background-color: var(--button-color);
Â  Â  Â  Â  Â  Â  color: var(--button-text-color);
Â  Â  Â  Â  Â  Â  border: none;
Â  Â  Â  Â  Â  Â  width: 28px;
Â  Â  Â  Â  Â  Â  height: 28px;
Â  Â  Â  Â  Â  Â  border-radius: 50%;
Â  Â  Â  Â  Â  Â  font-size: 16px;
Â  Â  Â  Â  }
Â  Â  Â  Â  
Â  Â  Â  Â  .total-info {
Â  Â  Â  Â  Â  Â  text-align: right;
Â  Â  Â  Â  Â  Â  padding: 15px 0;
Â  Â  Â  Â  Â  Â  font-size: 18px;
Â  Â  Â  Â  Â  Â  font-weight: bold;
Â  Â  Â  Â  Â  Â  border-top: 1px solid var(--hint-color);
Â  Â  Â  Â  Â  Â  margin-top: 15px;
Â  Â  Â  Â  }

Â  Â  </style>
</head>
<body>
Â  Â  
Â  Â  <div id="app-container">
Â  Â  Â  Â  
Â  Â  Â  Â  <div id="catalog-view">
Â  Â  Â  Â  Â  Â  <h2>ğŸ›ï¸ ĞšĞ°Ñ‚Ğ°Ğ»Ğ¾Ğ³ Ñ‚Ğ¾Ğ²Ğ°Ñ€Ğ¾Ğ²</h2>
Â  Â  Â  Â  Â  Â  <div id="catalog" class="catalog-grid">
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </div>
Â  Â  Â  Â  
Â  Â  Â  Â  <div id="cart-view" style="display: none;">
Â  Â  Â  Â  Â  Â  <h2>ğŸ›’ Ğ’Ğ°ÑˆĞ° ĞºĞ¾Ñ€Ğ·Ğ¸Ğ½Ğ°</h2>
Â  Â  Â  Â  Â  Â  <div id="cart-items">
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  <div id="order-form">
Â  Â  Â  Â  Â  Â  Â  Â  <h3>ĞšĞ¾Ğ½Ñ‚Ğ°ĞºÑ‚Ğ½Ñ‹Ğµ Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ</h3>
Â  Â  Â  Â  Â  Â  Â  Â  <input type="text" id="contact-name" placeholder="Ğ’Ğ°ÑˆĞµ Ğ¸Ğ¼Ñ" style="width: 100%; padding: 8px; margin-bottom: 10px; border-radius: 5px; border: 1px solid var(--hint-color); background-color: var(--secondary-bg-color); color: var(--text-color);" required>
Â  Â  Â  Â  Â  Â  Â  Â  <input type="text" id="delivery-address" placeholder="ĞĞ´Ñ€ĞµÑ Ğ´Ğ¾ÑÑ‚Ğ°Ğ²ĞºĞ¸" style="width: 100%; padding: 8px; margin-bottom: 10px; border-radius: 5px; border: 1px solid var(--hint-color); background-color: var(--secondary-bg-color); color: var(--text-color);" required>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  <div id="cart-total" class="total-info">
Â  Â  Â  Â  Â  Â  Â  Â  Ğ˜Ñ‚Ğ¾Ğ³Ğ¾: 0 Ñ€ÑƒĞ±.
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </div>
Â  Â  Â  Â  
Â  Â  </div>

Â  Â  <script>
Â  Â  Â  Â  const WebApp = window.Telegram.WebApp;
Â  Â  Â  Â  
Â  Â  Â  Â  // --- 1. ĞĞĞ¡Ğ¢Ğ ĞĞ™ĞšĞ˜ ---
Â  Â  Â  Â  // !!! ĞĞ§Ğ•ĞĞ¬ Ğ’ĞĞ–ĞĞ: Ğ—ĞĞœĞ•ĞĞ˜Ğ¢Ğ• Ğ­Ğ¢ĞĞ¢ ĞĞ”Ğ Ğ•Ğ¡ ĞĞ ĞŸĞ£Ğ‘Ğ›Ğ˜Ğ§ĞĞ«Ğ™ HTTPS-ĞĞ”Ğ Ğ•Ğ¡ Ğ’ĞĞ¨Ğ•Ğ“Ğ FLASK-Ğ¡Ğ•Ğ Ğ’Ğ•Ğ Ğ !!!
Â  Â  Â  Â  // Ğ’Ğ¡Ğ¢ĞĞ’Ğ›Ğ•Ğ Ğ ĞĞ‘ĞĞ§Ğ˜Ğ™ ĞĞ”Ğ Ğ•Ğ¡ Ğ¡ RENDER
Â  Â  Â  Â  const API_URL_BASE = 'https://telegram-flask1-api.onrender.com'; 
        const API_URL_PRODUCTS = API_URL_BASE + '/api/products';
        const API_URL_ORDER = API_URL_BASE + '/api/order';
Â  Â  Â  Â  
Â  Â  Â  Â  // ĞœĞ°ÑÑĞ¸Ğ²Ñ‹ Ğ´Ğ»Ñ Ñ…Ñ€Ğ°Ğ½ĞµĞ½Ğ¸Ñ Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ…
Â  Â  Â  Â  let allProducts = [];
Â  Â  Â  Â  let cart = JSON.parse(localStorage.getItem('telegramStoreCart')) || {}; // {itemId: {name, price, qty}}
Â  Â  Â  Â  let currentView = 'catalog'; // 'catalog' Ğ¸Ğ»Ğ¸ 'cart'

Â  Â  Â  Â  // --- 2. Ğ¤Ğ£ĞĞšĞ¦Ğ˜Ğ˜ Ğ˜ĞĞ˜Ğ¦Ğ˜ĞĞ›Ğ˜Ğ—ĞĞ¦Ğ˜Ğ˜ ---

Â  Â  Â  Â  function initApp() {
Â  Â  Â  Â  Â  Â  if (!WebApp.isExpanded) {
Â  Â  Â  Â  Â  Â  Â  Â  Â WebApp.expand();
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  WebApp.ready();
Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  // ĞĞ°ÑÑ‚Ñ€Ğ°Ğ¸Ğ²Ğ°ĞµĞ¼ ĞºĞ½Ğ¾Ğ¿ĞºÑƒ Ğ´Ğ»Ñ Ğ¿ĞµÑ€ĞµĞºĞ»ÑÑ‡ĞµĞ½Ğ¸Ñ/Ğ¾Ñ„Ğ¾Ñ€Ğ¼Ğ»ĞµĞ½Ğ¸Ñ
Â  Â  Â  Â  Â  Â  WebApp.MainButton.show();
Â  Â  Â  Â  Â  Â  WebApp.MainButton.onClick(handleMainButtonClick);

Â  Â  Â  Â  Â  Â  loadProducts();
Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  // Ğ•ÑĞ»Ğ¸ Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ Ğ´Ğ¾ÑÑ‚ÑƒĞ¿Ğ½Ñ‹, Ğ¿Ğ¾Ğ´ÑÑ‚Ğ°Ğ²Ğ»ÑĞµĞ¼ Ğ¸Ğ¼Ñ
Â  Â  Â  Â  Â  Â  if (WebApp.initDataUnsafe && WebApp.initDataUnsafe.user) {
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('contact-name').value = 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  WebApp.initDataUnsafe.user.first_name || '';
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }
Â  Â  Â  Â  
Â  Â  Â  Â  // --- 3. Ğ—ĞĞ“Ğ Ğ£Ğ—ĞšĞ Ğ”ĞĞĞĞ«Ğ¥ ---
Â  Â  Â  Â  
Â  Â  Â  Â  async function loadProducts() {
Â  Â  Â  Â  Â  Â  const catalogElement = document.getElementById('catalog');
Â  Â  Â  Â  Â  Â  catalogElement.innerHTML = '<p style="text-align: center; color: var(--hint-color);">Ğ—Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ° ĞºĞ°Ñ‚Ğ°Ğ»Ğ¾Ğ³Ğ°...</p>';
Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  // Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµĞ¼ Ğ½Ğ¾Ğ²Ñ‹Ğ¹ Ğ°Ğ´Ñ€ĞµÑ Ğ´Ğ»Ñ Ğ¿Ğ¾Ğ»ÑƒÑ‡ĞµĞ½Ğ¸Ñ Ñ‚Ğ¾Ğ²Ğ°Ñ€Ğ¾Ğ²
Â  Â  Â  Â  Â  Â  Â  Â  const response = await fetch(API_URL_PRODUCTS); 
Â  Â  Â  Â  Â  Â  Â  Â  if (!response.ok) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  throw new Error(`ĞÑˆĞ¸Ğ±ĞºĞ° HTTP: ${response.status}`);
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  allProducts = await response.json();
Â  Â  Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  Â  Â  displayProducts(allProducts);
Â  Â  Â  Â  Â  Â  Â  Â  updateMainButton(); // ĞĞ±Ğ½Ğ¾Ğ²Ğ»ÑĞµĞ¼ ĞºĞ½Ğ¾Ğ¿ĞºÑƒ Ğ¿Ğ¾ÑĞ»Ğµ Ğ·Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ¸
Â  Â  Â  Â  Â  Â  } catch (error) {
Â  Â  Â  Â  Â  Â  Â  Â  console.error("ĞĞµ ÑƒĞ´Ğ°Ğ»Ğ¾ÑÑŒ Ğ·Ğ°Ğ³Ñ€ÑƒĞ·Ğ¸Ñ‚ÑŒ Ñ‚Ğ¾Ğ²Ğ°Ñ€Ñ‹ Ñ API:", error);
Â  Â  Â  Â  Â  Â  Â  Â  catalogElement.innerHTML = '<h2>âŒ ĞĞµ ÑƒĞ´Ğ°Ğ»Ğ¾ÑÑŒ Ğ·Ğ°Ğ³Ñ€ÑƒĞ·Ğ¸Ñ‚ÑŒ ĞºĞ°Ñ‚Ğ°Ğ»Ğ¾Ğ³. ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑŒÑ‚Ğµ ÑĞµÑ€Ğ²ĞµÑ€.</h2>';
Â  Â  Â  Â  Â  Â  Â  Â  WebApp.MainButton.hide();
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }

Â  Â  Â  Â  // --- 4. ĞĞ¢ĞĞ‘Ğ ĞĞ–Ğ•ĞĞ˜Ğ• Ğ˜ĞĞ¢Ğ•Ğ Ğ¤Ğ•Ğ™Ğ¡Ğ ---
Â  Â  Â  Â  
Â  Â  Â  Â  function displayProducts(products) {
Â  Â  Â  Â  Â  Â  const catalogElement = document.getElementById('catalog');
Â  Â  Â  Â  Â  Â  catalogElement.innerHTML = ''; 

Â  Â  Â  Â  Â  Â  products.forEach(product => {
Â  Â  Â  Â  Â  Â  Â  Â  const itemHtml = `
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="product-item" data-id="${product.id}">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <img src="${product.image_url}" alt="${product.name}" class="product-image">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="product-info">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <h3>${product.name}</h3>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p class="product-description">${product.description ? product.description.substring(0, 50) + '...' : ''}</p>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p class="product-price">${(product.price || 0).toFixed(2)} Ñ€ÑƒĞ±.</p>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button class="add-to-cart-btn" onclick="addToCart('${product.id}')">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ${cart[product.id] ? 'Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ»ĞµĞ½Ğ¾ (' + cart[product.id].qty + ')' : 'Ğ’ ĞºĞ¾Ñ€Ğ·Ğ¸Ğ½Ñƒ'}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  `;
Â  Â  Â  Â  Â  Â  Â  Â  catalogElement.innerHTML += itemHtml;
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  }
Â  Â  Â  Â  
Â  Â  Â  Â  function renderCart() {
Â  Â  Â  Â  Â  Â  const cartItemsElement = document.getElementById('cart-items');
Â  Â  Â  Â  Â  Â  cartItemsElement.innerHTML = '';
Â  Â  Â  Â  Â  Â  let total = 0;
Â  Â  Â  Â  Â  Â  let cartEmpty = true;
Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  for (const id in cart) {
Â  Â  Â  Â  Â  Â  Â  Â  const item = cart[id];
Â  Â  Â  Â  Â  Â  Â  Â  if (item.qty > 0) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  cartEmpty = false;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const itemTotal = item.qty * item.price;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  total += itemTotal;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const itemHtml = `
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="cart-item">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="cart-item-info">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <b>${item.name}</b><br>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ${item.qty} x ${item.price.toFixed(2)} Ñ€ÑƒĞ±. = ${itemTotal.toFixed(2)} Ñ€ÑƒĞ±.
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="cart-item-controls">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button class="qty-btn" onclick="updateCartQty('${id}', -1)">-</button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span>${item.qty}</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button class="qty-btn" onclick="updateCartQty('${id}', 1)">+</button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  `;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  cartItemsElement.innerHTML += itemHtml;
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  if (cartEmpty) {
Â  Â  Â  Â  Â  Â  Â  Â  cartItemsElement.innerHTML = '<p style="text-align: center; color: var(--hint-color);">ĞšĞ¾Ñ€Ğ·Ğ¸Ğ½Ğ° Ğ¿ÑƒÑÑ‚Ğ° ğŸ˜”</p>';
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('order-form').style.display = 'none';
Â  Â  Â  Â  Â  Â  Â  Â  total = 0;
Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('order-form').style.display = 'block';
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  document.getElementById('cart-total').innerHTML = `Ğ˜Ñ‚Ğ¾Ğ³Ğ¾: ${total.toFixed(2)} Ñ€ÑƒĞ±.`;
Â  Â  Â  Â  }

Â  Â  Â  Â  // --- 5. Ğ›ĞĞ“Ğ˜ĞšĞ ĞšĞĞ Ğ—Ğ˜ĞĞ« ---
Â  Â  Â  Â  
Â  Â  Â  Â  function addToCart(productId) {
Â  Â  Â  Â  Â  Â  const product = allProducts.find(p => p.id === productId);
Â  Â  Â  Â  Â  Â  if (!product) return;

Â  Â  Â  Â  Â  Â  if (cart[productId]) {
Â  Â  Â  Â  Â  Â  Â  Â  cart[productId].qty += 1;
Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  cart[productId] = {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  name: product.name,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  price: product.price || 0,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  qty: 1
Â  Â  Â  Â  Â  Â  Â  Â  };
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  saveCart();
Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  // ĞĞ±Ğ½Ğ¾Ğ²Ğ»ÑĞµĞ¼ ĞºĞ½Ğ¾Ğ¿ĞºÑƒ ĞºĞ°Ñ‚Ğ°Ğ»Ğ¾Ğ³Ğ°
Â  Â  Â  Â  Â  Â  const btn = document.querySelector(`.product-item[data-id="${productId}"] .add-to-cart-btn`);
Â  Â  Â  Â  Â  Â  if (btn) {
Â  Â  Â  Â  Â  Â  Â  Â  btn.textContent = `Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ»ĞµĞ½Ğ¾ (${cart[productId].qty})`;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  updateMainButton();
Â  Â  Â  Â  }

Â  Â  Â  Â  function updateCartQty(productId, delta) {
Â  Â  Â  Â  Â  Â  if (!cart[productId]) return;

Â  Â  Â  Â  Â  Â  cart[productId].qty += delta;

Â  Â  Â  Â  Â  Â  if (cart[productId].qty <= 0) {
Â  Â  Â  Â  Â  Â  Â  Â  delete cart[productId];
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  saveCart();
Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  if (currentView === 'cart') {
Â  Â  Â  Â  Â  Â  Â  Â  renderCart();
Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  displayProducts(allProducts); // ĞĞ±Ğ½Ğ¾Ğ²Ğ»ÑĞµĞ¼ ĞºĞ½Ğ¾Ğ¿ĞºĞ¸ Ğ² ĞºĞ°Ñ‚Ğ°Ğ»Ğ¾Ğ³Ğµ
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  updateMainButton();
Â  Â  Â  Â  }
Â  Â  Â  Â  
Â  Â  Â  Â  function saveCart() {
Â  Â  Â  Â  Â  Â  localStorage.setItem('telegramStoreCart', JSON.stringify(cart));
Â  Â  Â  Â  }

Â  Â  Â  Â  function getCartTotal() {
Â  Â  Â  Â  Â  Â  let total = 0;
Â  Â  Â  Â  Â  Â  let count = 0;
Â  Â  Â  Â  Â  Â  for (const id in cart) {
Â  Â  Â  Â  Â  Â  Â  Â  if (cart[id].qty > 0) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  total += cart[id].qty * cart[id].price;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  count += cart[id].qty;
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  return { total: total, count: count };
Â  Â  Â  Â  }
Â  Â  Â  Â  
Â  Â  Â  Â  // --- 6. Ğ£ĞŸĞ ĞĞ’Ğ›Ğ•ĞĞ˜Ğ• ĞšĞĞĞŸĞšĞĞ™ Ğ¢Ğ•Ğ›Ğ•Ğ“Ğ ĞĞœ ---
Â  Â  Â  Â  
Â  Â  Â  Â  function updateMainButton() {
Â  Â  Â  Â  Â  Â  const { total, count } = getCartTotal();
Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  if (currentView === 'catalog' && count > 0) {
Â  Â  Â  Â  Â  Â  Â  Â  WebApp.MainButton.setText(`ĞŸĞµÑ€ĞµĞ¹Ñ‚Ğ¸ Ğ² ĞšĞ¾Ñ€Ğ·Ğ¸Ğ½Ñƒ (${count} ÑˆÑ‚. | ${total.toFixed(2)} Ñ€ÑƒĞ±.)`);
Â  Â  Â  Â  Â  Â  Â  Â  WebApp.MainButton.enable();
Â  Â  Â  Â  Â  Â  } else if (currentView === 'catalog' && count === 0) {
Â  Â  Â  Â  Â  Â  Â  Â  Â WebApp.MainButton.setText(`ĞšĞ¾Ñ€Ğ·Ğ¸Ğ½Ğ° Ğ¿ÑƒÑÑ‚Ğ°`);
Â  Â  Â  Â  Â  Â  Â  Â  Â WebApp.MainButton.disable();
Â  Â  Â  Â  Â  Â  } else if (currentView === 'cart' && count > 0) {
Â  Â  Â  Â  Â  Â  Â  Â  WebApp.MainButton.setText(`ĞÑ„Ğ¾Ñ€Ğ¼Ğ¸Ñ‚ÑŒ Ğ·Ğ°ĞºĞ°Ğ· (${total.toFixed(2)} Ñ€ÑƒĞ±.)`);
Â  Â  Â  Â  Â  Â  Â  Â  WebApp.MainButton.enable();
Â  Â  Â  Â  Â  Â  } else { // ĞšĞ¾Ñ€Ğ·Ğ¸Ğ½Ğ° Ğ¿ÑƒÑÑ‚Ğ° Ğ½Ğ° ÑÑ‚Ñ€Ğ°Ğ½Ğ¸Ñ†Ğµ ĞºĞ¾Ñ€Ğ·Ğ¸Ğ½Ñ‹
Â  Â  Â  Â  Â  Â  Â  Â  WebApp.MainButton.setText(`Ğ’ĞµÑ€Ğ½ÑƒÑ‚ÑŒÑÑ Ğ² ĞºĞ°Ñ‚Ğ°Ğ»Ğ¾Ğ³`);
Â  Â  Â  Â  Â  Â  Â  Â  WebApp.MainButton.enable();
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }
Â  Â  Â  Â  
Â  Â  Â  Â  function handleMainButtonClick() {
Â  Â  Â  Â  Â  Â  if (currentView === 'catalog') {
Â  Â  Â  Â  Â  Â  Â  Â  if (getCartTotal().count > 0) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // ĞŸĞµÑ€ĞµÑ…Ğ¾Ğ´ Ğ² ĞºĞ¾Ñ€Ğ·Ğ¸Ğ½Ñƒ
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  currentView = 'cart';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('catalog-view').style.display = 'none';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('cart-view').style.display = 'block';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  WebApp.BackButton.show(); // ĞŸĞ¾ĞºĞ°Ğ·Ñ‹Ğ²Ğ°ĞµĞ¼ ĞºĞ½Ğ¾Ğ¿ĞºÑƒ "ĞĞ°Ğ·Ğ°Ğ´"
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  renderCart();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  updateMainButton();
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  } else if (currentView === 'cart') {
Â  Â  Â  Â  Â  Â  Â  Â  if (getCartTotal().count > 0) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  placeOrder();
Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // Ğ’ĞµÑ€Ğ½ÑƒÑ‚ÑŒÑÑ Ğ² ĞºĞ°Ñ‚Ğ°Ğ»Ğ¾Ğ³, ĞµÑĞ»Ğ¸ ĞºĞ¾Ñ€Ğ·Ğ¸Ğ½Ğ° Ğ¿ÑƒÑÑ‚Ğ°
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  handleBackButtonClick(); 
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }
Â  Â  Â  Â  
Â  Â  Â  Â  WebApp.onEvent('backButtonClicked', handleBackButtonClick);

Â  Â  Â  Â  function handleBackButtonClick() {
Â  Â  Â  Â  Â  Â  Â currentView = 'catalog';
Â  Â  Â  Â  Â  Â  Â document.getElementById('catalog-view').style.display = 'block';
Â  Â  Â  Â  Â  Â  Â document.getElementById('cart-view').style.display = 'none';
Â  Â  Â  Â  Â  Â  Â WebApp.BackButton.hide(); // Ğ¡ĞºÑ€Ñ‹Ğ²Ğ°ĞµĞ¼ ĞºĞ½Ğ¾Ğ¿ĞºÑƒ "ĞĞ°Ğ·Ğ°Ğ´"
Â  Â  Â  Â  Â  Â  Â updateMainButton();
Â  Â  Â  Â  }
Â  Â  Â  Â  
Â  Â  Â  Â  // --- 7. ĞĞ¢ĞŸĞ ĞĞ’ĞšĞ Ğ—ĞĞšĞĞ—Ğ Ğ˜ Ğ¡ĞĞ¥Ğ ĞĞĞ•ĞĞ˜Ğ• Ğ’ DB ---
Â  Â  Â  Â  
Â  Â  Â  Â  async function placeOrder() {
Â  Â  Â  Â  Â  Â  const { total, count } = getCartTotal();
Â  Â  Â  Â  Â  Â  const contactName = document.getElementById('contact-name').value;
Â  Â  Â  Â  Â  Â  const address = document.getElementById('delivery-address').value;

Â  Â  Â  Â  Â  Â  if (!contactName || !address) {
Â  Â  Â  Â  Â  Â  Â  Â  WebApp.showAlert('ĞŸĞ¾Ğ¶Ğ°Ğ»ÑƒĞ¹ÑÑ‚Ğ°, Ğ·Ğ°Ğ¿Ğ¾Ğ»Ğ½Ğ¸Ñ‚Ğµ Ğ˜Ğ¼Ñ Ğ¸ ĞĞ´Ñ€ĞµÑ Ğ´Ğ¾ÑÑ‚Ğ°Ğ²ĞºĞ¸.');
Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  }
            
            WebApp.MainButton.showProgress(true); // ĞŸĞ¾ĞºĞ°Ğ·Ñ‹Ğ²Ğ°ĞµĞ¼ Ğ¿Ñ€Ğ¾Ğ³Ñ€ĞµÑÑ
            
Â  Â  Â  Â  Â  Â  const orderDetails = {
Â  Â  Â  Â  Â  Â  Â  Â  items: Object.values(cart).filter(item => item.qty > 0),
Â  Â  Â  Â  Â  Â  Â  Â  totalPrice: total, // ĞÑ‚Ğ¿Ñ€Ğ°Ğ²Ğ»ÑĞµĞ¼ Ñ‡Ğ¸ÑĞ»Ğ¾, Ğ° Ğ½Ğµ ÑÑ‚Ñ€Ğ¾ĞºÑƒ
Â  Â  Â  Â  Â  Â  Â  Â  totalCount: count,
Â  Â  Â  Â  Â  Â  Â  Â  contactName: contactName,
Â  Â  Â  Â  Â  Â  Â  Â  address: address,
Â  Â  Â  Â  Â  Â  Â  Â  // ĞÑ‚Ğ¿Ñ€Ğ°Ğ²Ğ»ÑĞµĞ¼ ID Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ Telegram Ğ´Ğ»Ñ Ğ¸Ğ´ĞµĞ½Ñ‚Ğ¸Ñ„Ğ¸ĞºĞ°Ñ†Ğ¸Ğ¸
Â  Â  Â  Â  Â  Â  Â  Â  telegramUserId: WebApp.initDataUnsafe.user ? WebApp.initDataUnsafe.user.id : 'unknown',
                telegramUserName: WebApp.initDataUnsafe.user ? WebApp.initDataUnsafe.user.username : 'n/a'
Â  Â  Â  Â  Â  Â  };

            try {
                // 1. ĞÑ‚Ğ¿Ñ€Ğ°Ğ²ĞºĞ° Ğ·Ğ°ĞºĞ°Ğ·Ğ° Ğ½Ğ° Ğ²Ğ°Ñˆ Flask-ÑĞµÑ€Ğ²ĞµÑ€ Ğ´Ğ»Ñ ÑĞ¾Ñ…Ñ€Ğ°Ğ½ĞµĞ½Ğ¸Ñ Ğ² Firestore
                const dbResponse = await fetch(API_URL_ORDER, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(orderDetails)
                });

                if (!dbResponse.ok) {
                    throw new Error(`ĞÑˆĞ¸Ğ±ĞºĞ° ÑĞµÑ€Ğ²ĞµÑ€Ğ° (${dbResponse.status}) Ğ¿Ñ€Ğ¸ ÑĞ¾Ñ…Ñ€Ğ°Ğ½ĞµĞ½Ğ¸Ğ¸ Ğ·Ğ°ĞºĞ°Ğ·Ğ°.`);
                }
                
                // 2. ĞŸĞ¾ÑĞ»Ğµ ÑƒÑĞ¿ĞµÑˆĞ½Ğ¾Ğ³Ğ¾ ÑĞ¾Ñ…Ñ€Ğ°Ğ½ĞµĞ½Ğ¸Ñ Ğ² Firestore, Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²Ğ»ÑĞµĞ¼ Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ Ğ±Ğ¾Ñ‚Ñƒ
                // ĞŸÑ€ĞµĞ¾Ğ±Ñ€Ğ°Ğ·ÑƒĞµĞ¼ Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ Ğ² ÑÑ‚Ñ€Ğ¾ĞºÑƒ (JSON) Ğ´Ğ»Ñ WebApp.sendData
                const dataToSend = JSON.stringify(orderDetails);
                WebApp.sendData(dataToSend);

                // ĞĞ¿Ğ¾Ğ²ĞµÑ‰ĞµĞ½Ğ¸Ğµ, Ğ¾Ñ‡Ğ¸ÑÑ‚ĞºĞ° Ğ¸ Ğ·Ğ°ĞºÑ€Ñ‹Ñ‚Ğ¸Ğµ
                WebApp.showAlert('âœ… Ğ’Ğ°Ñˆ Ğ·Ğ°ĞºĞ°Ğ· Ğ¿Ñ€Ğ¸Ğ½ÑÑ‚! Ğ‘Ğ¾Ñ‚ ÑĞºĞ¾Ñ€Ğ¾ Ğ¾Ñ‚Ğ²ĞµÑ‚Ğ¸Ñ‚.', () => {
                    localStorage.removeItem('telegramStoreCart'); // ĞÑ‡Ğ¸Ñ‰Ğ°ĞµĞ¼ ĞºĞ¾Ñ€Ğ·Ğ¸Ğ½Ñƒ
                    WebApp.close(); // Ğ—Ğ°ĞºÑ€Ñ‹Ğ²Ğ°ĞµĞ¼ Web App
                });

            } catch (error) {
                console.error("ĞÑˆĞ¸Ğ±ĞºĞ° Ğ¿Ñ€Ğ¸ Ğ¾Ñ„Ğ¾Ñ€Ğ¼Ğ»ĞµĞ½Ğ¸Ğ¸ Ğ·Ğ°ĞºĞ°Ğ·Ğ°:", error);
                WebApp.showAlert('âŒ ĞĞµ ÑƒĞ´Ğ°Ğ»Ğ¾ÑÑŒ Ğ¾Ñ„Ğ¾Ñ€Ğ¼Ğ¸Ñ‚ÑŒ Ğ·Ğ°ĞºĞ°Ğ·. ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑŒÑ‚Ğµ Ğ¿Ğ¾Ğ´ĞºĞ»ÑÑ‡ĞµĞ½Ğ¸Ğµ Ğº ÑĞµÑ€Ğ²ĞµÑ€Ñƒ Ğ¸Ğ»Ğ¸ Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ.');
            } finally {
                WebApp.MainButton.hideProgress(); // Ğ¡ĞºÑ€Ñ‹Ğ²Ğ°ĞµĞ¼ Ğ¿Ñ€Ğ¾Ğ³Ñ€ĞµÑÑ
            }
Â  Â  Â  Â  }

        // --- Ğ˜ĞĞ˜Ğ¦Ğ˜ĞĞ›Ğ˜Ğ—ĞĞ¦Ğ˜Ğ¯ ---
Â  Â  Â  Â  initApp();
Â  Â  </script>
</body>
</html>