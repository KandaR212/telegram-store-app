<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Telegram Web App –ú–∞–≥–∞–∑–∏–Ω</title>
    <!-- –ü–æ–¥–∫–ª—é—á–∞–µ–º Telegram Web App SDK -->
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <!-- –ü–æ–¥–∫–ª—é—á–∞–µ–º Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <style>
        /* –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ —Ü–≤–µ—Ç–æ–≤ Telegram */
        :root {
            --tg-bg-color: var(--tg-theme-bg-color, #ffffff);
            --tg-secondary-bg-color: var(--tg-theme-secondary-bg-color, #f4f4f5);
            --tg-text-color: var(--tg-theme-text-color, #000000);
            --tg-hint-color: var(--tg-theme-hint-color, #999999);
            --tg-button-color: var(--tg-theme-button-color, #5375c3);
            --tg-button-text-color: var(--tg-theme-button-text-color, #ffffff);
            --tg-link-color: var(--tg-theme-link-color, #2b84ff);
        }

        body {
            background-color: var(--tg-bg-color);
            color: var(--tg-text-color);
            font-family: 'Inter', sans-serif;
            margin: 0;
            padding: 0;
            overflow-x: hidden;
        }

        /* –û–±—â–∏–µ —Å—Ç–∏–ª–∏ –¥–ª—è Telegram Web App */
        .container-wrapper {
            max-width: 600px;
            margin: 0 auto;
            padding: 16px;
        }

        .card {
            background-color: var(--tg-secondary-bg-color);
            border: 1px solid var(--tg-secondary-bg-color);
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .card:hover {
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            transform: translateY(-2px);
        }

        .product-name {
            color: var(--tg-text-color);
        }

        .product-price {
            color: var(--tg-link-color);
            font-weight: 600;
        }
        
        /* –°—Ç–∏–ª–∏ –¥–ª—è –∫–Ω–æ–ø–∫–∏ "–î–æ–±–∞–≤–∏—Ç—å" */
        .add-to-cart-btn {
            background-color: var(--tg-button-color);
            color: var(--tg-button-text-color);
            transition: background-color 0.15s ease;
        }

        .add-to-cart-btn:hover {
            background-color: #4a68af; /* –ë–æ–ª–µ–µ —Ç–µ–º–Ω—ã–π –æ—Ç—Ç–µ–Ω–æ–∫ */
        }
    </style>
    
    <!-- –ù–∞—Å—Ç—Ä–æ–π–∫–∞ Tailwind –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è —Ü–≤–µ—Ç–æ–≤ Telegram -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'tg-bg': 'var(--tg-bg-color)',
                        'tg-secondary-bg': 'var(--tg-secondary-bg-color)',
                        'tg-text': 'var(--tg-theme-text-color)',
                        'tg-hint': 'var(--tg-hint-color)',
                        'tg-button': 'var(--tg-button-color)',
                        'tg-button-text': 'var(--tg-button-text-color)',
                        'tg-link': 'var(--tg-link-color)',
                    },
                }
            }
        }
    </script>
</head>
<body class="bg-tg-bg min-h-screen">

<div class="container-wrapper">

    <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ -->
    <h1 class="text-3xl font-bold mb-6 text-tg-text text-center">
        üß∏ –ö–∞—Ç–∞–ª–æ–≥ –¢–æ–≤–∞—Ä–æ–≤
    </h1>

    <!-- –ü–ê–ù–ï–õ–¨ –£–ü–†–ê–í–õ–ï–ù–ò–Ø (–°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞, –ü–æ–∏—Å–∫, –í–∞–ª—é—Ç–∞) -->
    <div class="mb-6 p-4 card rounded-xl shadow-lg flex flex-col sm:flex-row gap-4">
        
        <!-- –ü–æ–∏—Å–∫ -->
        <input 
            type="text" 
            id="search-input" 
            placeholder="üîé –ü–æ–∏—Å–∫ –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é..."
            class="w-full sm:w-1/2 p-2 rounded-lg bg-tg-bg border border-tg-hint/50 focus:ring-tg-link focus:border-tg-link transition text-tg-text"
            oninput="handleSearch()"
        />

        <div class="flex gap-4 w-full sm:w-1/2">
            <!-- –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ -->
            <select 
                id="sort-select" 
                class="w-1/2 p-2 rounded-lg bg-tg-bg border border-tg-hint/50 focus:ring-tg-link focus:border-tg-link transition text-tg-text"
                onchange="fetchProducts()"
            >
                <option value="name_asc">–ù–∞–∑–≤–∞–Ω–∏–µ (–ê-–Ø)</option>
                <option value="name_desc">–ù–∞–∑–≤–∞–Ω–∏–µ (–Ø-–ê)</option>
                <option value="price_asc">–¶–µ–Ω–∞ (—Å–Ω–∞—á–∞–ª–∞ –¥–µ—à–µ–≤—ã–µ)</option>
                <option value="price_desc">–¶–µ–Ω–∞ (—Å–Ω–∞—á–∞–ª–∞ –¥–æ—Ä–æ–≥–∏–µ)</option>
            </select>
            
            <!-- –í—ã–±–æ—Ä –≤–∞–ª—é—Ç—ã -->
            <select 
                id="currency-select" 
                class="w-1/2 p-2 rounded-lg bg-tg-bg border border-tg-hint/50 focus:ring-tg-link focus:border-tg-link transition text-tg-text"
                onchange="renderProducts(window.allProducts)"
            >
                <option value="USD">USD ($)</option>
                <option value="RUB">RUB (‚ÇΩ)</option>
            </select>
        </div>
    </div>

    <!-- –°–ø–∏—Å–æ–∫ —Ç–æ–≤–∞—Ä–æ–≤ -->
    <div id="products-container" class="grid grid-cols-1 sm:grid-cols-2 gap-4 pb-20">
        <!-- –¢–æ–≤–∞—Ä—ã –±—É–¥—É—Ç –∑–∞–≥—Ä—É–∂–µ–Ω—ã —Å—é–¥–∞ -->
    </div>
    
    <!-- –°–æ–æ–±—â–µ–Ω–∏–µ –æ –∑–∞–≥—Ä—É–∑–∫–µ/–æ—à–∏–±–∫–µ -->
    <div id="status-message" class="text-center text-tg-hint p-8">
        –ó–∞–≥—Ä—É–∑–∫–∞ —Ç–æ–≤–∞—Ä–æ–≤...
    </div>

</div>

<script>
    // --- –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø ---
    // URL –≤–∞—à–µ–≥–æ —Ä–∞–∑–≤–µ—Ä–Ω—É—Ç–æ–≥–æ Flask-—Å–µ—Ä–≤–µ—Ä–∞ (–ó–∞–º–µ–Ω–∏—Ç–µ –Ω–∞ –≤–∞—à —Ñ–∞–∫—Ç–∏—á–µ—Å–∫–∏–π URL)
    const API_BASE_URL = "https://telegram-store-server.render.com"; 
    const API_URL_PRODUCTS = `${API_BASE_URL}/api/products`;
    const API_URL_ORDER = `${API_BASE_URL}/api/order`;
    const USD_TO_RUB_RATE = 90; // –ü—Ä–∏–º–µ—Ä–Ω—ã–π –∫—É—Ä—Å

    // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è –¥–∞–Ω–Ω—ã—Ö
    let cart = {}; // {productId: quantity}
    window.allProducts = []; // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤—Å–µ –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã–µ —Ç–æ–≤–∞—Ä—ã
    
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Telegram Web App
    const WebApp = window.Telegram.WebApp;
    WebApp.ready();
    WebApp.expand();
    
    // --- –§–£–ù–ö–¶–ò–ò –ö–û–†–ó–ò–ù–´ ---

    // –ó–∞–≥—Ä—É–∑–∫–∞ –∫–æ—Ä–∑–∏–Ω—ã –∏–∑ –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ —Ö—Ä–∞–Ω–∏–ª–∏—â–∞
    function loadCart() {
        const savedCart = localStorage.getItem('telegramStoreCart');
        if (savedCart) {
            try {
                cart = JSON.parse(savedCart);
            } catch (e) {
                console.error("–û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ –∫–æ—Ä–∑–∏–Ω—ã:", e);
                cart = {};
            }
        }
    }

    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–æ—Ä–∑–∏–Ω—ã
    function updateCart(productId, quantityChange) {
        if (quantityChange > 0) {
            cart[productId] = (cart[productId] || 0) + quantityChange;
        } else {
            cart[productId] = (cart[productId] || 0) + quantityChange;
            if (cart[productId] <= 0) {
                delete cart[productId];
            }
        }
        localStorage.setItem('telegramStoreCart', JSON.stringify(cart));
        updateMainButton();
        renderProducts(getFilteredProducts());
    }

    // –†–∞—Å—á–µ—Ç –æ–±—â–µ–π —Å—É–º–º—ã
    function calculateTotal() {
        let total = 0;
        const productsMap = window.allProducts.reduce((map, p) => {
            map[p.id] = p;
            return map;
        }, {});

        for (const id in cart) {
            const product = productsMap[id];
            if (product) {
                // –ü—Ä–µ–¥–ø–æ–ª–∞–≥–∞–µ–º, —á—Ç–æ —Ü–µ–Ω–∞ –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö –≤—Å–µ–≥–¥–∞ –≤ USD
                const price = parseFloat(product.price) || 0;
                total += price * cart[id];
            }
        }
        return total;
    }
    
    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≥–ª–∞–≤–Ω–æ–π –∫–Ω–æ–ø–∫–∏ Telegram Web App
    function updateMainButton() {
        const total = calculateTotal();
        const currency = document.getElementById('currency-select').value;
        
        if (Object.keys(cart).length > 0) {
            let displayTotal;
            if (currency === 'RUB') {
                displayTotal = (total * USD_TO_RUB_RATE).toFixed(2) + ' ‚ÇΩ';
            } else {
                displayTotal = total.toFixed(2) + ' $';
            }
            
            WebApp.MainButton.setText(`üõí –û—Ñ–æ—Ä–º–∏—Ç—å –∑–∞–∫–∞–∑: ${displayTotal}`);
            WebApp.MainButton.show();
        } else {
            WebApp.MainButton.hide();
        }
    }

    // --- –§–£–ù–ö–¶–ò–ò –î–õ–Ø API, –ü–û–ò–°–ö–ê –ò –°–û–†–¢–ò–†–û–í–ö–ò ---
    
    // –ü–æ–ª—É—á–µ–Ω–∏–µ –æ—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤–∞–Ω–Ω—ã—Ö –∏ –æ—Ç—Å–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö —Ç–æ–≤–∞—Ä–æ–≤ (—Ç–æ–ª—å–∫–æ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—è –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é)
    function getFilteredProducts() {
        const searchInput = document.getElementById('search-input').value.toLowerCase();
        
        if (!searchInput) {
            return window.allProducts;
        }

        // –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è —Ç–æ–≤–∞—Ä–æ–≤ –Ω–∞ –æ—Å–Ω–æ–≤–µ –≤–≤–æ–¥–∞
        return window.allProducts.filter(p => 
            p.name.toLowerCase().includes(searchInput) || 
            p.description.toLowerCase().includes(searchInput)
        );
    }
    
    // –ü–æ–ª—É—á–µ–Ω–∏–µ —Ç–æ–≤–∞—Ä–æ–≤ —Å —Å–µ—Ä–≤–µ—Ä–∞ (–≤–∫–ª—é—á–∞–µ—Ç —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫—É)
    async function fetchProducts() {
        const statusMessage = document.getElementById('status-message');
        const productsContainer = document.getElementById('products-container');
        
        productsContainer.innerHTML = '';
        statusMessage.textContent = '–ó–∞–≥—Ä—É–∑–∫–∞ —Ç–æ–≤–∞—Ä–æ–≤...';
        statusMessage.classList.remove('hidden');
        
        // –ü–æ–ª—É—á–∞–µ–º –ø–∞—Ä–∞–º–µ—Ç—Ä—ã —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏
        const sortValue = document.getElementById('sort-select').value;
        const [sort_by, sort_order] = sortValue.split('_');

        const url = `${API_URL_PRODUCTS}?sort_by=${sort_by}&sort_order=${sort_order}`;
        
        try {
            const response = await fetch(url);
            if (!response.ok) {
                // –ï—Å–ª–∏ –æ—à–∏–±–∫–∞ HTTP, –≤—ã–±—Ä–∞—Å—ã–≤–∞–µ–º –æ—à–∏–±–∫—É —Å –∫–æ–¥–æ–º —Å—Ç–∞—Ç—É—Å–∞
                throw new Error(`–û—à–∏–±–∫–∞ HTTP: ${response.status}`);
            }
            window.allProducts = await response.json();
            
            if (window.allProducts.length === 0) {
                statusMessage.textContent = '–°–ø–∏—Å–æ–∫ —Ç–æ–≤–∞—Ä–æ–≤ –ø—É—Å—Ç.';
            } else {
                statusMessage.classList.add('hidden');
            }
            
            // –ü–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏ –∏ —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏, –æ—Ç–æ–±—Ä–∞–∂–∞–µ–º –∏ —Ñ–∏–ª—å—Ç—Ä—É–µ–º –≤ –ø–∞–º—è—Ç–∏
            renderProducts(getFilteredProducts()); 
            updateMainButton();
            
        } catch (error) {
            // –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–∫–∏ 'Failed to fetch' –∏–ª–∏ HTTP-–æ—à–∏–±–∫–∏
            console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Ç–æ–≤–∞—Ä–æ–≤:", error);
            // –ò—Å–ø–æ–ª—å–∑—É–µ–º in-page —Å–æ–æ–±—â–µ–Ω–∏–µ, —Ç–∞–∫ –∫–∞–∫ WebApp.showAlert –º–æ–∂–µ—Ç –Ω–µ —Ä–∞–±–æ—Ç–∞—Ç—å
            statusMessage.textContent = `‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Ç–æ–≤–∞—Ä—ã. ${error.message}. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ URL —Å–µ—Ä–≤–µ—Ä–∞ –∏ CORS.`;
        }
    }

    // –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤–≤–æ–¥–∞ –≤ –ø–æ–ª–µ –ø–æ–∏—Å–∫–∞ (–≤—ã–∑—ã–≤–∞–µ—Ç –ø–µ—Ä–µ—Ä–∏—Å–æ–≤–∫—É, –Ω–æ –Ω–µ –∑–∞–≥—Ä—É–∑–∫—É)
    function handleSearch() {
        const filteredProducts = getFilteredProducts();
        renderProducts(filteredProducts);
    }

    // --- –§–£–ù–ö–¶–ò–ò –†–ï–ù–î–ï–†–ò–ù–ì–ê ---
    
    // –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ü–µ–Ω—ã
    function formatPrice(priceUSD) {
        const currency = document.getElementById('currency-select').value;
        const price = parseFloat(priceUSD) || 0;
        
        let formattedPrice;
        if (currency === 'RUB') {
            formattedPrice = (price * USD_TO_RUB_RATE).toFixed(2) + ' ‚ÇΩ';
        } else {
            formattedPrice = price.toFixed(2) + ' $';
        }
        return formattedPrice;
    }

    // –†–µ–Ω–¥–µ—Ä–∏–Ω–≥ —Å–ø–∏—Å–∫–∞ —Ç–æ–≤–∞—Ä–æ–≤
    function renderProducts(products) {
        const productsContainer = document.getElementById('products-container');
        productsContainer.innerHTML = '';
        const statusMessage = document.getElementById('status-message');
        
        if (!products || products.length === 0) {
            statusMessage.textContent = '–¢–æ–≤–∞—Ä—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –∏–∑–º–µ–Ω–∏—Ç—å —É—Å–ª–æ–≤–∏—è –ø–æ–∏—Å–∫–∞.';
            statusMessage.classList.remove('hidden');
            return;
        } else {
            statusMessage.classList.add('hidden');
        }

        products.forEach(product => {
            const currentQuantity = cart[product.id] || 0;
            const cardHtml = `
                <div class="card p-4 rounded-xl shadow-md flex flex-col justify-between">
                    <div>
                        <!-- –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ-–∑–∞–≥–ª—É—à–∫–∞, –µ—Å–ª–∏ –Ω–µ—Ç —Ä–µ–∞–ª—å–Ω–æ–≥–æ URL -->
                        <img 
                            src="${product.imageUrl || 'https://placehold.co/400x200/FFC0CB/FFFFFF?text=Product'}" 
                            onerror="this.onerror=null;this.src='https://placehold.co/400x200/FFC0CB/FFFFFF?text=Product';"
                            alt="${product.name}" 
                            class="w-full h-32 object-cover rounded-lg mb-3 shadow-inner"
                        >
                        <h2 class="product-name text-lg font-semibold mb-1">${product.name}</h2>
                        <p class="text-sm text-tg-hint mb-2">${product.description || '–û–ø–∏—Å–∞–Ω–∏–µ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç.'}</p>
                    </div>

                    <div class="flex items-center justify-between mt-3">
                        <span class="product-price text-xl">
                            ${formatPrice(product.price)}
                        </span>
                        
                        <!-- –ì—Ä—É–ø–ø–∞ –∫–Ω–æ–ø–æ–∫ +/- -->
                        <div class="flex items-center space-x-2">
                            ${currentQuantity > 0 ? `
                                <button onclick="updateCart('${product.id}', -1)" class="bg-red-500 hover:bg-red-600 text-white font-bold py-1 px-3 rounded-full shadow-md transition">
                                    ‚Äì
                                </button>
                                <span class="text-tg-text font-medium">${currentQuantity}</span>
                            ` : ''}

                            <button onclick="updateCart('${product.id}', 1)" class="add-to-cart-btn font-bold py-1 px-3 rounded-full shadow-md transition">
                                ${currentQuantity > 0 ? '+' : '–í –∫–æ—Ä–∑–∏–Ω—É'}
                            </button>
                        </div>
                    </div>
                </div>
            `;
            productsContainer.insertAdjacentHTML('beforeend', cardHtml);
        });
        
        updateMainButton(); // –û–±–Ω–æ–≤–ª—è–µ–º –∫–Ω–æ–ø–∫—É –ø–æ—Å–ª–µ —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥–∞
    }

    // --- –§–£–ù–ö–¶–ò–Ø –û–§–û–†–ú–õ–ï–ù–ò–Ø –ó–ê–ö–ê–ó–ê ---

    WebApp.MainButton.onClick(placeOrder);

    async function placeOrder() {
        if (Object.keys(cart).length === 0) {
            console.warn('–ö–æ—Ä–∑–∏–Ω–∞ –ø—É—Å—Ç–∞. –ù–µ–≤–æ–∑–º–æ–∂–Ω–æ –æ—Ñ–æ—Ä–º–∏—Ç—å –∑–∞–∫–∞–∑.');
            return;
        }

        const productsMap = window.allProducts.reduce((map, p) => {
            map[p.id] = p;
            return map;
        }, {});

        const orderItems = Object.entries(cart)
            .filter(([id, quantity]) => quantity > 0 && productsMap[id])
            .map(([id, quantity]) => {
                const product = productsMap[id];
                return {
                    id: id,
                    name: product.name,
                    price_usd: parseFloat(product.price) || 0,
                    quantity: quantity
                };
            });
        
        const totalUSD = calculateTotal();
        const currency = document.getElementById('currency-select').value;

        const orderDetails = {
            // –î–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è Telegram
            user_id: WebApp.initDataUnsafe.user?.id,
            username: WebApp.initDataUnsafe.user?.username,
            first_name: WebApp.initDataUnsafe.user?.first_name,
            
            // –î–µ—Ç–∞–ª–∏ –∑–∞–∫–∞–∑–∞
            items: orderItems,
            total_usd: totalUSD,
            total_rub: totalUSD * USD_TO_RUB_RATE,
            currency_at_checkout: currency,
            date: new Date().toISOString(),
            // 'status' –±—É–¥–µ—Ç –¥–æ–±–∞–≤–ª–µ–Ω –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ Flask
        };

        WebApp.MainButton.showProgress();

        try {
            // 1. –û—Ç–ø—Ä–∞–≤–∫–∞ –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è –Ω–∞ –≤–∞—à Flask-—Å–µ—Ä–≤–µ—Ä –¥–ª—è –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è –≤ Firestore
            const dbResponse = await fetch(API_URL_ORDER, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(orderDetails)
            });

            if (!dbResponse.ok) {
                throw new Error(`–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞ (${dbResponse.status}) –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –∑–∞–∫–∞–∑–∞.`);
            }
            
            // 2. –ü–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–≥–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –≤ Firestore, –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ –±–æ—Ç—É
            const dataToSend = JSON.stringify(orderDetails);
            WebApp.sendData(dataToSend);

            // –û—á–∏—Å—Ç–∫–∞ –∏ –∑–∞–∫—Ä—ã—Ç–∏–µ (—É–±—Ä–∞–ª–∏ WebApp.showAlert, —á—Ç–æ–±—ã –∏–∑–±–µ–∂–∞—Ç—å –æ—à–∏–±–∫–∏ 6.0/showPopup)
            localStorage.removeItem('telegramStoreCart'); // –û—á–∏—â–∞–µ–º –∫–æ—Ä–∑–∏–Ω—É
            WebApp.close(); // –ó–∞–∫—Ä—ã–≤–∞–µ–º Web App
            
            console.log("‚úÖ –ó–∞–∫–∞–∑ —É—Å–ø–µ—à–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –∏ Web App –∑–∞–∫—Ä—ã–≤–∞–µ—Ç—Å—è.");

        } catch (error) {
            console.error("‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏–∏ –∑–∞–∫–∞–∑–∞:", error);
            // –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ç–æ–ª—å–∫–æ –∫–æ–Ω—Å–æ–ª—å –∏ –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –ø—Ä–æ–≥—Ä–µ—Å—Å–∞ –¥–ª—è –æ–±—Ä–∞—Ç–Ω–æ–π —Å–≤—è–∑–∏ –ø—Ä–∏ –æ—à–∏–±–∫–µ
            // –î–ª—è —Ä–µ–∞–ª—å–Ω–æ–≥–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –ª—É—á—à–µ –¥–æ–±–∞–≤–∏—Ç—å –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –Ω–∞ —Å–∞–º–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü–µ.
        } finally {
            WebApp.MainButton.hideProgress(); 
        }
    }

    // --- –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø ---
    function initApp() {
        loadCart();
        fetchProducts(); // –ó–∞–≥—Ä—É–∂–∞–µ–º –∏ –æ—Ç–æ–±—Ä–∞–∂–∞–µ–º —Ç–æ–≤–∞—Ä—ã
    }

    initApp();
</script>
</body>
</html>