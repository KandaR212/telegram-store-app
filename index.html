<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Telegram Web App Store</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    
    <style>
        /* –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö —Ü–≤–µ—Ç–æ–≤ Telegram */
        :root {
            --bg-color: var(--tg-theme-bg-color, #ffffff);
            --secondary-bg-color: var(--tg-theme-secondary-bg-color, #f4f4f5);
            --text-color: var(--tg-theme-text-color, #000000);
            --hint-color: var(--tg-theme-hint-color, #999999);
            --button-color: var(--tg-theme-button-color, #5375c3);
            --button-text-color: var(--tg-theme-button-text-color, #ffffff);
            --link-color: var(--tg-theme-link-color, #2b84ff);
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen, Ubuntu, Cantarell, "Fira Sans", "Droid Sans", "Helvetica Neue", sans-serif;
            margin: 0;
            padding: 10px;
            background-color: var(--bg-color);
            color: var(--text-color);
            transition: background-color 0.3s;
        }

        h2 {
            color: var(--text-color);
            margin-bottom: 20px;
            text-align: center;
        }

        /* --- –ö–∞—Ç–∞–ª–æ–≥ --- */
        #catalog, #cart-view {
            padding: 10px 0;
        }

        .catalog-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
        }

        .product-item {
            background-color: var(--secondary-bg-color);
            border-radius: 12px;
            overflow: hidden;
            text-align: center;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            display: flex;
            flex-direction: column;
        }

        .product-image {
            width: 100%;
            height: 120px;
            object-fit: cover;
            background-color: #ccc;
            border-bottom: 1px solid rgba(0, 0, 0, 0.05);
        }

        .product-info {
            padding: 10px;
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }
        
        .product-info h3 {
            font-size: 16px;
            margin: 0 0 5px;
        }
        
        .product-description {
            font-size: 12px;
            color: var(--hint-color);
            margin: 0 0 10px;
            line-height: 1.3;
        }

        .product-price {
            font-weight: bold;
            color: var(--text-color);
            font-size: 18px;
            margin: 5px 0 10px;
        }

        .add-to-cart-btn {
            background-color: var(--button-color);
            color: var(--button-text-color);
            border: none;
            padding: 8px 15px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            width: 100%;
            margin-top: auto; /* –ü—Ä–∏–∂–∏–º–∞–µ—Ç –∫–Ω–æ–ø–∫—É –∫ –Ω–∏–∑—É */
        }
        
        /* --- –ö–æ—Ä–∑–∏–Ω–∞ --- */
        .cart-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            margin-bottom: 8px;
            background-color: var(--secondary-bg-color);
            border-radius: 8px;
        }
        
        .cart-item-info {
            flex-grow: 1;
            padding-right: 10px;
        }
        
        .cart-item-controls {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .qty-btn {
            background-color: var(--button-color);
            color: var(--button-text-color);
            border: none;
            width: 28px;
            height: 28px;
            border-radius: 50%;
            font-size: 16px;
        }
        
        .total-info {
            text-align: right;
            padding: 15px 0;
            font-size: 18px;
            font-weight: bold;
            border-top: 1px solid var(--hint-color);
            margin-top: 15px;
        }

    </style>
</head>
<body>
    
    <div id="app-container">
        
        <div id="catalog-view">
            <h2>üõçÔ∏è –ö–∞—Ç–∞–ª–æ–≥ —Ç–æ–≤–∞—Ä–æ–≤</h2>
            <div id="catalog" class="catalog-grid">
                </div>
        </div>
        
        <div id="cart-view" style="display: none;">
            <h2>üõí –í–∞—à–∞ –∫–æ—Ä–∑–∏–Ω–∞</h2>
            <div id="cart-items">
                </div>
            <div id="order-form">
                <h3>–ö–æ–Ω—Ç–∞–∫—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ</h3>
                <input type="text" id="contact-name" placeholder="–í–∞—à–µ –∏–º—è" style="width: 100%; padding: 8px; margin-bottom: 10px; border-radius: 5px; border: 1px solid var(--hint-color); background-color: var(--secondary-bg-color); color: var(--text-color);" required>
                <input type="text" id="delivery-address" placeholder="–ê–¥—Ä–µ—Å –¥–æ—Å—Ç–∞–≤–∫–∏" style="width: 100%; padding: 8px; margin-bottom: 10px; border-radius: 5px; border: 1px solid var(--hint-color); background-color: var(--secondary-bg-color); color: var(--text-color);" required>
            </div>
            <div id="cart-total" class="total-info">
                –ò—Ç–æ–≥–æ: 0 —Ä—É–±.
            </div>
        </div>
        
    </div>

    <script>
        const WebApp = window.Telegram.WebApp;
        
        // --- 1. –ù–ê–°–¢–†–û–ô–ö–ò ---
        // !!! –û–ß–ï–ù–¨ –í–ê–ñ–ù–û: –ó–ê–ú–ï–ù–ò–¢–ï –≠–¢–û–¢ –ê–î–†–ï–° –ù–ê –ü–£–ë–õ–ò–ß–ù–´–ô HTTPS-–ê–î–†–ï–° –í–ê–®–ï–ì–û FLASK-–°–ï–†–í–ï–†–ê !!!
        const API_URL = 'https://[–í–ê–®_–ü–£–ë–õ–ò–ß–ù–´–ô_–î–û–ú–ï–ù]/api/products'; 
        
        // –ú–∞—Å—Å–∏–≤—ã –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö
        let allProducts = [];
        let cart = JSON.parse(localStorage.getItem('telegramStoreCart')) || {}; // {itemId: {name, price, qty}}
        let currentView = 'catalog'; // 'catalog' –∏–ª–∏ 'cart'

        // --- 2. –§–£–ù–ö–¶–ò–ò –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–ò ---

        function initApp() {
            if (!WebApp.isExpanded) {
                 WebApp.expand();
            }
            WebApp.ready();
            
            // –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –∫–Ω–æ–ø–∫—É –¥–ª—è –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è/–æ—Ñ–æ—Ä–º–ª–µ–Ω–∏—è
            WebApp.MainButton.show();
            WebApp.MainButton.onClick(handleMainButtonClick);

            loadProducts();
            
            // –ï—Å–ª–∏ –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –¥–æ—Å—Ç—É–ø–Ω—ã, –ø–æ–¥—Å—Ç–∞–≤–ª—è–µ–º –∏–º—è
            if (WebApp.initDataUnsafe && WebApp.initDataUnsafe.user) {
                document.getElementById('contact-name').value = 
                    WebApp.initDataUnsafe.user.first_name || '';
            }
        }
        
        // --- 3. –ó–ê–ì–†–£–ó–ö–ê –î–ê–ù–ù–´–• ---
        
        async function loadProducts() {
            const catalogElement = document.getElementById('catalog');
            catalogElement.innerHTML = '<p style="text-align: center; color: var(--hint-color);">–ó–∞–≥—Ä—É–∑–∫–∞ –∫–∞—Ç–∞–ª–æ–≥–∞...</p>';
            
            try {
                const response = await fetch(API_URL);
                if (!response.ok) {
                    throw new Error(`–û—à–∏–±–∫–∞ HTTP: ${response.status}`);
                }
                allProducts = await response.json();
                
                displayProducts(allProducts);
                updateMainButton(); // –û–±–Ω–æ–≤–ª—è–µ–º –∫–Ω–æ–ø–∫—É –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏
            } catch (error) {
                console.error("–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Ç–æ–≤–∞—Ä—ã —Å API:", error);
                catalogElement.innerHTML = '<h2>‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∫–∞—Ç–∞–ª–æ–≥. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å–µ—Ä–≤–µ—Ä.</h2>';
                WebApp.MainButton.hide();
            }
        }

        // --- 4. –û–¢–û–ë–†–ê–ñ–ï–ù–ò–ï –ò–ù–¢–ï–†–§–ï–ô–°–ê ---
        
        function displayProducts(products) {
            const catalogElement = document.getElementById('catalog');
            catalogElement.innerHTML = ''; 

            products.forEach(product => {
                const itemHtml = `
                    <div class="product-item" data-id="${product.id}">
                        <img src="${product.image_url}" alt="${product.name}" class="product-image">
                        <div class="product-info">
                            <div>
                                <h3>${product.name}</h3>
                                <p class="product-description">${product.description ? product.description.substring(0, 50) + '...' : ''}</p>
                            </div>
                            <p class="product-price">${(product.price || 0).toFixed(2)} —Ä—É–±.</p>
                            <button class="add-to-cart-btn" onclick="addToCart('${product.id}')">
                                ${cart[product.id] ? '–î–æ–±–∞–≤–ª–µ–Ω–æ (' + cart[product.id].qty + ')' : '–í –∫–æ—Ä–∑–∏–Ω—É'}
                            </button>
                        </div>
                    </div>
                `;
                catalogElement.innerHTML += itemHtml;
            });
        }
        
        function renderCart() {
            const cartItemsElement = document.getElementById('cart-items');
            cartItemsElement.innerHTML = '';
            let total = 0;
            let cartEmpty = true;
            
            for (const id in cart) {
                const item = cart[id];
                if (item.qty > 0) {
                    cartEmpty = false;
                    const itemTotal = item.qty * item.price;
                    total += itemTotal;
                    
                    const itemHtml = `
                        <div class="cart-item">
                            <div class="cart-item-info">
                                <b>${item.name}</b><br>
                                ${item.qty} x ${item.price.toFixed(2)} —Ä—É–±. = ${itemTotal.toFixed(2)} —Ä—É–±.
                            </div>
                            <div class="cart-item-controls">
                                <button class="qty-btn" onclick="updateCartQty('${id}', -1)">-</button>
                                <span>${item.qty}</span>
                                <button class="qty-btn" onclick="updateCartQty('${id}', 1)">+</button>
                            </div>
                        </div>
                    `;
                    cartItemsElement.innerHTML += itemHtml;
                }
            }
            
            if (cartEmpty) {
                cartItemsElement.innerHTML = '<p style="text-align: center; color: var(--hint-color);">–ö–æ—Ä–∑–∏–Ω–∞ –ø—É—Å—Ç–∞ üòî</p>';
                document.getElementById('order-form').style.display = 'none';
                total = 0;
            } else {
                document.getElementById('order-form').style.display = 'block';
            }

            document.getElementById('cart-total').innerHTML = `–ò—Ç–æ–≥–æ: ${total.toFixed(2)} —Ä—É–±.`;
        }

        // --- 5. –õ–û–ì–ò–ö–ê –ö–û–†–ó–ò–ù–´ ---
        
        function addToCart(productId) {
            const product = allProducts.find(p => p.id === productId);
            if (!product) return;

            if (cart[productId]) {
                cart[productId].qty += 1;
            } else {
                cart[productId] = {
                    name: product.name,
                    price: product.price || 0,
                    qty: 1
                };
            }
            
            saveCart();
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –∫–Ω–æ–ø–∫—É –∫–∞—Ç–∞–ª–æ–≥–∞
            const btn = document.querySelector(`.product-item[data-id="${productId}"] .add-to-cart-btn`);
            if (btn) {
                btn.textContent = `–î–æ–±–∞–≤–ª–µ–Ω–æ (${cart[productId].qty})`;
            }
            
            updateMainButton();
        }

        function updateCartQty(productId, delta) {
            if (!cart[productId]) return;

            cart[productId].qty += delta;

            if (cart[productId].qty <= 0) {
                delete cart[productId];
            }
            
            saveCart();
            
            if (currentView === 'cart') {
                renderCart();
            } else {
                displayProducts(allProducts); // –û–±–Ω–æ–≤–ª—è–µ–º –∫–Ω–æ–ø–∫–∏ –≤ –∫–∞—Ç–∞–ª–æ–≥–µ
            }
            updateMainButton();
        }
        
        function saveCart() {
            localStorage.setItem('telegramStoreCart', JSON.stringify(cart));
        }

        function getCartTotal() {
            let total = 0;
            let count = 0;
            for (const id in cart) {
                if (cart[id].qty > 0) {
                    total += cart[id].qty * cart[id].price;
                    count += cart[id].qty;
                }
            }
            return { total: total, count: count };
        }
        
        // --- 6. –£–ü–†–ê–í–õ–ï–ù–ò–ï –ö–ù–û–ü–ö–û–ô –¢–ï–õ–ï–ì–†–ê–ú ---
        
        function updateMainButton() {
            const { total, count } = getCartTotal();
            
            if (currentView === 'catalog' && count > 0) {
                WebApp.MainButton.setText(`–ü–µ—Ä–µ–π—Ç–∏ –≤ –ö–æ—Ä–∑–∏–Ω—É (${count} —à—Ç. | ${total.toFixed(2)} —Ä—É–±.)`);
                WebApp.MainButton.enable();
            } else if (currentView === 'catalog' && count === 0) {
                 WebApp.MainButton.setText(`–ö–æ—Ä–∑–∏–Ω–∞ –ø—É—Å—Ç–∞`);
                 WebApp.MainButton.disable();
            } else if (currentView === 'cart' && count > 0) {
                WebApp.MainButton.setText(`–û—Ñ–æ—Ä–º–∏—Ç—å –∑–∞–∫–∞–∑ (${total.toFixed(2)} —Ä—É–±.)`);
                WebApp.MainButton.enable();
            } else { // –ö–æ—Ä–∑–∏–Ω–∞ –ø—É—Å—Ç–∞ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ –∫–æ—Ä–∑–∏–Ω—ã
                WebApp.MainButton.setText(`–í–µ—Ä–Ω—É—Ç—å—Å—è –≤ –∫–∞—Ç–∞–ª–æ–≥`);
                WebApp.MainButton.enable();
            }
        }
        
        function handleMainButtonClick() {
            if (currentView === 'catalog') {
                if (getCartTotal().count > 0) {
                    // –ü–µ—Ä–µ—Ö–æ–¥ –≤ –∫–æ—Ä–∑–∏–Ω—É
                    currentView = 'cart';
                    document.getElementById('catalog-view').style.display = 'none';
                    document.getElementById('cart-view').style.display = 'block';
                    WebApp.BackButton.show(); // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É "–ù–∞–∑–∞–¥"
                    renderCart();
                    updateMainButton();
                }
            } else if (currentView === 'cart') {
                if (getCartTotal().count > 0) {
                    placeOrder();
                } else {
                    // –í–µ—Ä–Ω—É—Ç—å—Å—è –≤ –∫–∞—Ç–∞–ª–æ–≥, –µ—Å–ª–∏ –∫–æ—Ä–∑–∏–Ω–∞ –ø—É—Å—Ç–∞
                    handleBackButtonClick(); 
                }
            }
        }
        
        WebApp.onEvent('backButtonClicked', handleBackButtonClick);

        function handleBackButtonClick() {
             currentView = 'catalog';
             document.getElementById('catalog-view').style.display = 'block';
             document.getElementById('cart-view').style.display = 'none';
             WebApp.BackButton.hide(); // –°–∫—Ä—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É "–ù–∞–∑–∞–¥"
             updateMainButton();
        }
        
        // --- 7. –û–¢–ü–†–ê–í–ö–ê –ó–ê–ö–ê–ó–ê –ë–û–¢–£ ---
        
        function placeOrder() {
            const { total, count } = getCartTotal();
            const contactName = document.getElementById('contact-name').value;
            const address = document.getElementById('delivery-address').value;

            if (!contactName || !address) {
                WebApp.showAlert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∑–∞–ø–æ–ª–Ω–∏—Ç–µ –ò–º—è –∏ –ê–¥—Ä–µ—Å –¥–æ—Å—Ç–∞–≤–∫–∏.');
                return;
            }

            const orderDetails = {
                items: Object.values(cart).filter(item => item.qty > 0),
                totalPrice: total.toFixed(2),
                totalCount: count,
                contactName: contactName,
                address: address,
                // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è Telegram –¥–ª—è –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏
                telegramUserId: WebApp.initDataUnsafe.user ? WebApp.initDataUnsafe.user.id : 'unknown'
            };

            // –ü—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –≤ —Å—Ç—Ä–æ–∫—É (JSON)
            const dataToSend = JSON.stringify(orderDetails);

            // –û—Ç–ø—Ä–∞–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö –±–æ—Ç—É
            WebApp.sendData(dataToSend);

            // –û–ø–æ–≤–µ—â–µ–Ω–∏–µ, –æ—á–∏—Å—Ç–∫–∞ –∏ –∑–∞–∫—Ä—ã—Ç–∏–µ
            WebApp.showAlert('‚úÖ –í–∞—à –∑–∞–∫–∞–∑ –ø—Ä–∏–Ω—è—Ç! –ë–æ—Ç —Å–∫–æ—Ä–æ –æ—Ç–≤–µ—Ç–∏—Ç.', () => {
                localStorage.removeItem('telegramStoreCart'); // –û—á–∏—â–∞–µ–º –∫–æ—Ä–∑–∏–Ω—É