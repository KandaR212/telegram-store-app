<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Telegram Web App –ú–∞–≥–∞–∑–∏–Ω</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    
    <style>
        /* –í–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è –∑–º—ñ–Ω–Ω–∏—Ö –∫–æ–ª—å–æ—Ä—ñ–≤ Telegram */
        :root {
            --bg-color: var(--tg-theme-bg-color, #ffffff);
            --secondary-bg-color: var(--tg-theme-secondary-bg-color, #f4f4f5);
            --text-color: var(--tg-theme-text-color, #000000);
            --hint-color: var(--tg-theme-hint-color, #999999);
            --button-color: var(--tg-theme-button-color, #5375c3);
            --button-text-color: var(--tg-theme-button-text-color, #ffffff);
            --link-color: var(--tg-theme-link-color, #2b84ff);

            /* –ù–û–í–Ü: –†–æ–∂–µ–≤—ñ –∫–æ–ª—å–æ—Ä–∏ */
            --pink-light: #FFEDED; /* –î—É–∂–µ —Å–≤—ñ—Ç–ª–∏–π —Ä–æ–∂–µ–≤–∏–π –¥–ª—è —Ñ–æ–Ω—É */
            --pink-medium: #FFC0CB; /* –°–µ—Ä–µ–¥–Ω—ñ–π —Ä–æ–∂–µ–≤–∏–π –¥–ª—è —Ñ–æ–Ω—É –∫–∞—Ä—Ç–æ–∫/–µ–ª–µ–º–µ–Ω—Ç—ñ–≤ */
            --pink-dark: #FF69B4; /* –¢–µ–º–Ω–æ-—Ä–æ–∂–µ–≤–∏–π –¥–ª—è –∫–Ω–æ–ø–æ–∫/–≤–∞–∂–ª–∏–≤–∏—Ö –µ–ª–µ–º–µ–Ω—Ç—ñ–≤ */
            --pink-text: #880044; /* –¢–µ–º–Ω–æ-—Ä–æ–∂–µ–≤–∏–π –¥–ª—è –∑–∞–≥–æ–ª–æ–≤–∫—ñ–≤/–∞–∫—Ü–µ–Ω—Ç–Ω–æ–≥–æ —Ç–µ–∫—Å—Ç—É */
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen, Ubuntu, Cantarell, "Fira Sans", "Droid Sans", "Helvetica Neue", sans-serif;
            margin: 0;
            padding: 10px;
            background-color: var(--pink-light); 
            color: var(--text-color);
            transition: background-color 0.3s;
        }

        h2 {
            color: var(--pink-text); 
            margin-bottom: 20px;
            text-align: center;
        }

        /* --- –ö–∞—Ç–∞–ª–æ–≥ --- */
        #catalog, #cart-view {
            padding: 10px 0;
        }

        .catalog-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
        }

        .product-item {
            background-color: var(--pink-medium); 
            border-radius: 12px;
            overflow: hidden;
            text-align: center;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.15); 
            display: flex;
            flex-direction: column;
            cursor: pointer; 
            transition: transform 0.2s ease-in-out;
        }

        .product-item:hover {
            transform: translateY(-3px); 
        }

        .product-image {
            width: 100%;
            height: 120px; 
            object-fit: cover; 
            background-color: #f0e0e0; 
            border-bottom: 1px solid rgba(0, 0, 0, 0.1);
        }

        .product-info {
            padding: 10px;
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }
        
        .product-info h3 {
            font-size: 16px;
            margin: 0 0 5px;
            color: var(--pink-text); 
        }
        
        .product-description {
            font-size: 12px;
            color: var(--hint-color);
            margin: 0 0 10px;
            line-height: 1.3;
            height: 3.9em; 
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .product-price {
            font-weight: bold;
            color: var(--pink-dark); 
            font-size: 18px;
            margin: 5px 0 10px;
            display: block;
        }

        .original-price {
            color: var(--hint-color); /* –°–µ—Ä—ã–π —Ü–≤–µ—Ç */
            font-size: 14px;
            text-decoration: line-through; /* –ó–∞—á–µ—Ä–∫–Ω—É—Ç—ã–π —Ç–µ–∫—Å—Ç */
            margin-right: 10px;
            font-weight: normal;
        }

        .discount-badge {
            background-color: #e6005c; /* –Ø—Ä–∫–∏–π —Ü–≤–µ—Ç –¥–ª—è —Å–∫–∏–¥–∫–∏ */
            color: white;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: bold;
            margin-left: 10px;
        }

        .price-display {
            display: flex;
            justify-content: center;
            align-items: center;
            margin: 5px 0 10px;
        }

        .add-to-cart-btn {
            background-color: var(--pink-dark); 
            color: var(--button-text-color);
            border: none;
            padding: 8px 15px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            width: 100%;
            margin-top: auto; 
            transition: background-color 0.2s;
        }
        .add-to-cart-btn:hover {
            background-color: #e04a99; 
        }
        
        /* --- –ö–æ—à–∏–∫ --- */
        .cart-item {
            background-color: var(--pink-medium); 
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            padding: 10px;
            margin-bottom: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .qty-btn {
            background-color: var(--pink-dark); 
            color: var(--button-text-color);
            border: none;
            width: 28px;
            height: 28px;
            border-radius: 50%;
            font-size: 16px;
            transition: background-color 0.2s;
        }
        .qty-btn:hover {
            background-color: #e04a99;
        }

        .total-info {
            text-align: right;
            padding: 15px 0;
            font-size: 18px;
            font-weight: bold;
            border-top: 1px solid var(--pink-text); 
            margin-top: 15px;
            color: var(--pink-dark);
        }

        /* –°—Ç–∏–ª—ñ –¥–ª—è –ø–æ–ª—ñ–≤ –≤–≤–µ–¥–µ–Ω–Ω—è */
        #contact-name, #delivery-address {
            background-color: var(--secondary-bg-color); 
            border: 1px solid var(--pink-medium) !important;
        }

        /* –ù–û–í–Ü –°–¢–ò–õ–Ü –¥–ª—è —Å–æ—Ä—Ç—É–≤–∞–Ω–Ω—è */
        .sort-controls {
            margin-bottom: 20px; 
            display: flex; 
            align-items: center;
            background-color: var(--secondary-bg-color);
            padding: 10px;
            border-radius: 8px;
        }
        .sort-controls label {
            margin-right: 10px; 
            font-weight: bold; 
            color: var(--pink-text);
        }
        #sort-select {
            padding: 8px; 
            border-radius: 5px; 
            width: 100%;
            /* –î–æ–¥–∞—Ç–∫–æ–≤—ñ —Å—Ç–∏–ª—ñ, —è–∫—ñ –≤–∂–µ —î –≤ —ñ–Ω—à–æ–º—É –º—ñ—Å—Ü—ñ, –∞–ª–µ –¥–æ–¥–∞–º–æ —Å—é–¥–∏, —â–æ–± –±—É–ª–æ —á–∏—Å—Ç–æ */
            background-color: var(--secondary-bg-color); 
            border: 1px solid var(--pink-medium) !important;
            color: var(--text-color);
        }

        /* --- –ú–æ–¥–∞–ª—å–Ω–µ –≤—ñ–∫–Ω–æ –¥–ª—è –¥–µ—Ç–∞–ª–µ–π —Ç–æ–≤–∞—Ä—É --- */
        .modal {
            display: none; 
            position: fixed; 
            z-index: 1000; 
            left: 0;
            top: 0;
            width: 100%; 
            height: 100%; 
            overflow: auto; 
            background-color: rgba(0,0,0,0.6); 
            backdrop-filter: blur(5px); 
            -webkit-backdrop-filter: blur(5px); 
            padding-top: 20px;
        }

        .modal-content {
            background-color: var(--bg-color); 
            margin: 10% auto; 
            padding: 20px;
            border-radius: 15px;
            width: 90%;
            max-width: 600px; 
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            position: relative;
            color: var(--text-color);
            animation: fadeIn 0.3s ease-out; 
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .close-button {
            color: var(--hint-color);
            font-size: 30px;
            font-weight: bold;
            position: absolute;
            top: 10px;
            right: 20px;
            cursor: pointer;
            transition: color 0.2s;
        }
        .close-button:hover, .close-button:focus {
            color: var(--pink-dark);
        }

        .detail-image-gallery {
            display: flex;
            overflow-x: auto; 
            scroll-snap-type: x mandatory;
            gap: 10px;
            margin-bottom: 15px;
            border-radius: 8px;
            background-color: var(--secondary-bg-color);
            padding: 10px;
            min-height: 250px; 
        }

        .detail-image-gallery::-webkit-scrollbar {
            height: 8px;
        }
        .detail-image-gallery::-webkit-scrollbar-thumb {
            background: var(--pink-medium);
            border-radius: 10px;
        }
        .detail-image-gallery::-webkit-scrollbar-track {
            background: var(--pink-light);
            border-radius: 10px;
        }

        .detail-image-gallery img {
            flex-shrink: 0; 
            width: 100%; 
            max-width: 100%; 
            height: 250px; 
            object-fit: contain; 
            border-radius: 8px;
            scroll-snap-align: start;
            background-color: #f0f0f0;
        }
        
        .detail-image-gallery.single-image {
            justify-content: center;
            overflow-x: hidden;
            padding: 0;
            background-color: transparent;
        }
        .detail-image-gallery.single-image img {
            width: auto;
            max-width: 100%;
        }


        .detail-title {
            font-size: 24px;
            font-weight: bold;
            color: var(--pink-dark);
            margin-bottom: 10px;
        }

        .detail-description {
            font-size: 14px;
            line-height: 1.5;
            color: var(--text-color);
            margin-bottom: 15px;
        }

        .detail-price {
            font-size: 22px;
            font-weight: bold;
            color: var(--pink-dark);
            margin-bottom: 15px;
        }

        .detail-add-to-cart-btn {
            background-color: var(--pink-dark);
            color: var(--button-text-color);
            border: none;
            padding: 12px 20px;
            border-radius: 10px;
            cursor: pointer;
            font-size: 16px;
            width: 100%;
            transition: background-color 0.2s;
        }
        .detail-add-to-cart-btn:hover {
            background-color: #e04a99;
        }
    </style>
</head>
<body>
    
    <div id="app-container">
        
        <div id="catalog-view">
            <h2>üõçÔ∏è –ö–∞—Ç–∞–ª–æ–≥ —Ç–æ–≤–∞—Ä—ñ–≤</h2>

            <div class="sort-controls">
                <label for="sort-select">–°–æ—Ä—Ç—É–≤–∞—Ç–∏:</label>
                <select id="sort-select" onchange="loadProducts()">
                    <option value="name_asc">–ù–∞–∑–≤–∞ (–ê-–Ø)</option>
                    <option value="name_desc">–ù–∞–∑–≤–∞ (–Ø-–ê)</option>
                    <option value="price_asc">–¶—ñ–Ω–∞ (–≤—ñ–¥ –Ω–∏–∑—å–∫–æ—ó)</option>
                    <option value="price_desc">–¶—ñ–Ω–∞ (–≤—ñ–¥ –≤–∏—Å–æ–∫–æ—ó)</option>
                </select>
            </div>
            <div id="catalog" class="catalog-grid">
            </div>
        </div>
            
        <div id="cart-view" style="display: none;">
            <h2>üõí –í–∞—à –∫–æ—à–∏–∫</h2>
            <div id="cart-items">
                </div>
            <div id="order-form">
                <h3>–ö–æ–Ω—Ç–∞–∫—Ç–Ω—ñ –¥–∞–Ω—ñ —Ç–∞ –¥–æ—Å—Ç–∞–≤–∫–∞</h3>
                <input type="text" id="contact-name" placeholder="–í–∞—à–µ —ñ–º'—è" style="width: 100%; padding: 8px; margin-bottom: 10px; border-radius: 5px; border: 1px solid var(--hint-color); background-color: var(--secondary-bg-color); color: var(--text-color);" required>
                <input type="text" id="delivery-address" placeholder="–ê–¥—Ä–µ—Å–∞ –¥–æ—Å—Ç–∞–≤–∫–∏" style="width: 100%; padding: 8px; margin-bottom: 10px; border-radius: 5px; border: 1px solid var(--hint-color); background-color: var(--secondary-bg-color); color: var(--text-color);" required>
            </div>
            <div id="cart-total" class="total-info">
                –í—Å—å–æ–≥–æ: 0 –≥—Ä–Ω.
            </div>
        </div>
        
    </div>

    <div id="product-detail-modal" class="modal">
        <div class="modal-content">
            <span class="close-button" onclick="closeProductDetail()">&times;</span>
            <div id="detail-image-gallery" class="detail-image-gallery">
                </div>
            <h3 id="detail-title" class="detail-title"></h3>
            <p id="detail-description" class="detail-description"></p>
            <p id="detail-price" class="detail-price"></p>
            <button id="detail-add-to-cart-btn" class="detail-add-to-cart-btn" onclick="addToCartFromDetail()"></button>
        </div>
    </div>

    <script>
        const WebApp = window.Telegram.WebApp;
        
        // --- 1. –ù–ê–õ–ê–®–¢–£–í–ê–ù–ù–Ø ---
        // –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–π—Ç–µ –≤–∞—à –∞–∫—Ç—É–∞–ª—å–Ω–∏–π API_URL_BASE
        const API_URL_BASE = 'https://telegram-flask1-api.onrender.com';¬†
        const API_URL_PRODUCTS = API_URL_BASE + '/api/products';
        const API_URL_ORDER = API_URL_BASE + '/api/order';
        
        // –ú–∞—Å–∏–≤–∏ –¥–ª—è –∑–±–µ—Ä—ñ–≥–∞–Ω–Ω—è –¥–∞–Ω–∏—Ö
        let allProducts = [];
        let cart = JSON.parse(localStorage.getItem('telegramStoreCart')) || {}; // {itemId: {name, price, qty}}
        let currentView = 'catalog'; // 'catalog' –∞–±–æ 'cart'
        let currentProductInDetail = null; 

        // --- 2. –§–£–ù–ö–¶–Ü–á –Ü–ù–Ü–¶–Ü–ê–õ–Ü–ó–ê–¶–Ü–á ---

        function initApp() {
            if (!WebApp.isExpanded) {
                 WebApp.expand();
            }
            WebApp.ready();
            
            WebApp.MainButton.show();
            WebApp.MainButton.onClick(handleMainButtonClick);
            WebApp.onEvent('backButtonClicked', handleBackButtonClick);

            loadProducts();
            
            if (WebApp.initDataUnsafe && WebApp.initDataUnsafe.user) {
                document.getElementById('contact-name').value =¬†
                    WebApp.initDataUnsafe.user.first_name || '';
            }
        }
        
        // --- 3. –ó–ê–í–ê–ù–¢–ê–ñ–ï–ù–ù–Ø –î–ê–ù–ò–• ---
        
        async function loadProducts() {
            const catalogElement = document.getElementById('catalog');
            catalogElement.innerHTML = '<p style="text-align: center; color: var(--hint-color);">–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –∫–∞—Ç–∞–ª–æ–≥—É...</p>';
    
    // –û—Ç—Ä–∏–º—É—î–º–æ –≤–∏–±—Ä–∞–Ω–µ –∑–Ω–∞—á–µ–Ω–Ω—è —Å–æ—Ä—Ç—É–≤–∞–Ω–Ω—è
            const sortSelect = document.getElementById('sort-select');
    // –Ø–∫—â–æ —Å–µ–ª–µ–∫—Ç–æ—Ä –∑–Ω–∞–π–¥–µ–Ω–æ, –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î–º–æ –π–æ–≥–æ –∑–Ω–∞—á–µ–Ω–Ω—è, —ñ–Ω–∞–∫—à–µ - –¥–µ—Ñ–æ–ª—Ç
            const selectedSortValue = sortSelect ? sortSelect.value : 'name_asc'; 
    
    // –†–æ–∑–±–∏–≤–∞—î–º–æ –∑–Ω–∞—á–µ–Ω–Ω—è –Ω–∞ –ø–æ–ª–µ ('name' –∞–±–æ 'price') —Ç–∞ –Ω–∞–ø—Ä—è–º–æ–∫ ('asc' –∞–±–æ 'desc')
            const [sort_by, sort_order] = selectedSortValue.split('_');
    
            try {
        // –§–æ—Ä–º—É—î–º–æ URL –¥–ª—è –∑–∞–ø–∏—Ç—É –∑ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏ —Å–æ—Ä—Ç—É–≤–∞–Ω–Ω—è
                let url = new URL(API_URL_PRODUCTS);
                url.searchParams.append('sort_by', sort_by);
                url.searchParams.append('sort_order', sort_order);

        // –í—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—è —Ç–∞–π–º–∞—É—Ç—É –¥–ª—è –∑–∞–ø–æ–±—ñ–≥–∞–Ω–Ω—è –Ω–µ—Å–∫—ñ–Ω—á–µ–Ω–Ω–æ–≥–æ –æ—á—ñ–∫—É–≤–∞–Ω–Ω—è
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 10000); // 10 —Å–µ–∫—É–Ω–¥ —Ç–∞–π–º–∞—É—Ç
        
                const response = await fetch(url.toString(), { signal: controller.signal });
                clearTimeout(timeoutId); // –û—á–∏—Å—Ç–∏—Ç–∏ —Ç–∞–π–º–∞—É—Ç, —è–∫—â–æ –∑–∞–ø–∏—Ç —É—Å–ø—ñ—à–Ω–∏–π

        
                if (!response.ok) {
                    throw new Error(`–ü–æ–º–∏–ª–∫–∞ HTTP: ${response.status}`);
                }
        
                allProducts = await response.json();
        
                displayProducts(allProducts);
                updateMainButton(); 
            } catch (error) {
                console.error("–ù–µ –≤–¥–∞–ª–æ—Å—è –∑–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ —Ç–æ–≤–∞—Ä–∏ –∑ API:", error);
                if (error.name === 'AbortError') {
                    catalogElement.innerHTML = '<h2>‚ùå –ü–µ—Ä–µ–≤–∏—â–µ–Ω–æ —á–∞—Å –æ—á—ñ–∫—É–≤–∞–Ω–Ω—è. –ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ –∑\'—î–¥–Ω–∞–Ω–Ω—è –∑ —Å–µ—Ä–≤–µ—Ä–æ–º.</h2>';
                } else {
                    catalogElement.innerHTML = '<h2>‚ùå –ù–µ –≤–¥–∞–ª–æ—Å—è –∑–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ –∫–∞—Ç–∞–ª–æ–≥. –ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ —Å–µ—Ä–≤–µ—Ä.</h2>';
                }
                WebApp.MainButton.hide();
            }
        }

        // --- 4. –í–Ü–î–û–ë–†–ê–ñ–ï–ù–ù–Ø –Ü–ù–¢–ï–†–§–ï–ô–°–£ ---
        
        function displayProducts(products) {
            const catalogElement = document.getElementById('catalog');
            catalogElement.innerHTML = ''; 

            products.forEach(product => {
                // –í–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è –≥—Ä–Ω
                const priceFormatted = (product.price || 0).toFixed(2) + ' –≥—Ä–Ω.';
                const qty = cart[product.id] ? cart[product.id].qty : 0;
                
                const finalPrice = product.final_price || 0; 
                const originalPrice = product.original_price || 0;
                const isOnSale = product.is_on_sale;
                const discount = product.discount_percentage || 0;

                const finalPriceFormatted = finalPrice.toFixed(2) + ' –≥—Ä–Ω.';

                // HTML –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è —Ü–µ–Ω—ã
                let priceHtml = '';
                if (isOnSale && originalPrice > finalPrice) {
                    // –ï—Å–ª–∏ –µ—Å—Ç—å —Å–∫–∏–¥–∫–∞
                    priceHtml = `
                        <div class="price-display">
                            <span class="original-price">${originalPrice.toFixed(2)} –≥—Ä–Ω.</span>
                            <span class="product-price">${finalPriceFormatted}</span>
                            <span class="discount-badge">-${discount}%</span>
                        </div>
                    `;
                } else {
                    // –ï—Å–ª–∏ –Ω–µ—Ç —Å–∫–∏–¥–∫–∏
                    priceHtml = `<p class="product-price">${finalPriceFormatted}</p>`;
                }
                // --- –ö–û–ù–ï–¶ –ù–û–í–´–• –ü–ï–†–ï–ú–ï–ù–ù–´–• ---

                const qty = cart[product.id] ? cart[product.id].qty : 0;

                const itemHtml = `
                    <div class="product-item" data-id="${product.id}" onclick="showProductDetail('${product.id}')">
                        <img src="${product.image_url}" alt="${product.name}" class="product-image">
                        <div class="product-info">
                            <div>
                                <h3>${product.name}</h3>
                                <p class="product-description">${product.description ? product.description : ''}</p>
                            </div>

                            ${priceHtml} 

                            <button class="add-to-cart-btn" onclick="event.stopPropagation(); addToCart('${product.id}')">
                                ${qty > 0 ? `–î–æ–¥–∞–Ω–æ (${qty})` : '–í –∫–æ—à–∏–∫'}
                            </button>
                        </div>
                    </div>
                `;
                catalogElement.innerHTML += itemHtml;
            });
        }
        
        function renderCart() {
            const cartItemsElement = document.getElementById('cart-items');
            cartItemsElement.innerHTML = '';
            let total = 0;
            let cartEmpty = true;
            
            for (const id in cart) {
                const item = cart[id];
                if (item.qty > 0) {
                    cartEmpty = false;
                    const itemTotal = item.qty * item.price;
                    total += itemTotal;
                    
                    const itemHtml = `
                        <div class="cart-item">
                            <div class="cart-item-info">
                                <b>${item.name}</b><br>
                                ${item.qty} x ${item.price.toFixed(2)} –≥—Ä–Ω. = ${itemTotal.toFixed(2)} –≥—Ä–Ω.
                            </div>
                            <div class="cart-item-controls">
                                <button class="qty-btn" onclick="updateCartQty('${id}', -1)">-</button>
                                <span>${item.qty}</span>
                                <button class="qty-btn" onclick="updateCartQty('${id}', 1)">+</button>
                            </div>
                        </div>
                    `;
                    cartItemsElement.innerHTML += itemHtml;
                }
            }
            
            if (cartEmpty) {
                cartItemsElement.innerHTML = '<p style="text-align: center; color: var(--hint-color);">–ö–æ—à–∏–∫ –ø–æ—Ä–æ–∂–Ω—ñ–π üòî</p>';
                document.getElementById('order-form').style.display = 'none';
                total = 0;
            } else {
                document.getElementById('order-form').style.display = 'block';
            }

            document.getElementById('cart-total').innerHTML = `–í—Å—å–æ–≥–æ: ${total.toFixed(2)} –≥—Ä–Ω.`;
        }
        
        // --- –î–ï–¢–ê–õ–Ü –¢–û–í–ê–†–£ (–ú–æ–¥–∞–ª—å–Ω–µ –≤—ñ–∫–Ω–æ) ---

        function showProductDetail(productId) {
            const product = allProducts.find(p => p.id === productId);
            if (!product) return;

            currentProductInDetail = product; 

            // –ó–∞–ø–æ–≤–Ω—é—î–º–æ –º–æ–¥–∞–ª—å–Ω–µ –≤—ñ–∫–Ω–æ –¥–∞–Ω–∏–º–∏ (–≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î–º–æ –≥—Ä–Ω)
            document.getElementById('detail-title').textContent = product.name;
            document.getElementById('detail-description').textContent = product.description;
            document.getElementById('detail-price').textContent = `${(product.price || 0).toFixed(2)} –≥—Ä–Ω.`;

            const galleryElement = document.getElementById('detail-image-gallery');
            galleryElement.innerHTML = '';
            
            const images = (Array.isArray(product.images_url) && product.images_url.length > 0) 
                           ? product.images_url 
                           : [product.image_url];
            
            if (images.length > 1) {
                galleryElement.classList.remove('single-image');
            } else {
                galleryElement.classList.add('single-image');
            }

            images.forEach(url => {
                const img = document.createElement('img');
                img.src = url;
                img.alt = product.name;
                galleryElement.appendChild(img);
            });

            // –û–Ω–æ–≤–ª—é—î–º–æ —Ç–µ–∫—Å—Ç –∫–Ω–æ–ø–∫–∏ "–í –∫–æ—à–∏–∫" —É –º–æ–¥–∞–ª—å–Ω–æ–º—É –≤—ñ–∫–Ω—ñ
            const detailAddBtn = document.getElementById('detail-add-to-cart-btn');
            const qty = cart[product.id] ? cart[product.id].qty : 0;
            
            if (qty > 0) {
                detailAddBtn.textContent = `–î–æ–¥–∞–Ω–æ –¥–æ –∫–æ—à–∏–∫–∞ (${qty})`;
            } else {
                detailAddBtn.textContent = '–î–æ–¥–∞—Ç–∏ –¥–æ –∫–æ—à–∏–∫–∞';
            }
            detailAddBtn.dataset.productId = product.id; 

            // –ü–æ–∫–∞–∑—É—î–º–æ –º–æ–¥–∞–ª—å–Ω–µ –≤—ñ–∫–Ω–æ
            document.getElementById('product-detail-modal').style.display = 'block';
            WebApp.MainButton.hide(); 
            WebApp.BackButton.show(); 
            // –í–∏–º–∏–∫–∞—î–º–æ –∑–∞–≥–∞–ª—å–Ω–∏–π –æ–±—Ä–æ–±–Ω–∏–∫ —ñ –≤–º–∏–∫–∞—î–º–æ –æ–±—Ä–æ–±–Ω–∏–∫ –¥–ª—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –≤—ñ–∫–Ω–∞
            WebApp.offEvent('backButtonClicked', handleBackButtonClick); 
            WebApp.onEvent('backButtonClicked', closeProductDetail); 
        }

        function closeProductDetail() {
            document.getElementById('product-detail-modal').style.display = 'none';
            // –í—ñ–¥–ø–∏—Å—É—î–º–æ—Å—å –≤—ñ–¥ –∑–∞–∫—Ä–∏—Ç—Ç—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –≤—ñ–∫–Ω–∞ —Ç–∞ –≤—ñ–¥–Ω–æ–≤–ª—é—î–º–æ –∑–∞–≥–∞–ª—å–Ω–∏–π –æ–±—Ä–æ–±–Ω–∏–∫
            WebApp.offEvent('backButtonClicked', closeProductDetail); 
            WebApp.onEvent('backButtonClicked', handleBackButtonClick);

            // –í—ñ–¥–Ω–æ–≤–ª—é—î–º–æ —Å—Ç–∞–Ω –∫–Ω–æ–ø–æ–∫
            updateMainButton(); 
            if (currentView === 'catalog') {
                WebApp.BackButton.hide();
            } else { // 'cart'
                WebApp.BackButton.show();
            }
        }

        function addToCartFromDetail() {
            if (currentProductInDetail) {
                addToCart(currentProductInDetail.id);
                // –û–Ω–æ–≤–ª—é—î–º–æ —Ç–µ–∫—Å—Ç –∫–Ω–æ–ø–∫–∏ –≤ –º–æ–¥–∞–ª—å–Ω–æ–º—É –≤—ñ–∫–Ω—ñ
                const detailAddBtn = document.getElementById('detail-add-to-cart-btn');
                if (cart[currentProductInDetail.id]) {
                    detailAddBtn.textContent = `–î–æ–¥–∞–Ω–æ –¥–æ –∫–æ—à–∏–∫–∞ (${cart[currentProductInDetail.id].qty})`;
                }
                WebApp.showPopup({message: `"${currentProductInDetail.name}" –¥–æ–¥–∞–Ω–æ –¥–æ –∫–æ—à–∏–∫–∞!`});
            }
        }
        
        // --- 5. –õ–û–ì–Ü–ö–ê –ö–û–®–ò–ö–ê ---
        
        function addToCart(productId) {
            const product = allProducts.find(p => p.id === productId);
            if (!product) return;

            // --- –ò–ó–ú–ï–ù–ï–ù–ò–ï –ó–î–ï–°–¨: –ò—Å–ø–æ–ª—å–∑—É–µ–º final_price ---
            const priceToUse = product.final_price || 0; 

            if (cart[productId]) {
                cart[productId].qty += 1;
            } else {
                cart[productId] = {
                    name: product.name,
                    price: priceToUse, // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ñ–∏–Ω–∞–ª—å–Ω—É—é —Ü–µ–Ω—É
                    qty: 1
                };
            }
            
            saveCart();
            
            // –û–ù–û–í–õ–ï–ù–ù–Ø: –î–æ–¥–∞–Ω–æ –ø–æ–≤–Ω–µ –æ–Ω–æ–≤–ª–µ–Ω–Ω—è –∫–∞—Ç–∞–ª–æ–≥—É, —â–æ–± —É–Ω–∏–∫–Ω—É—Ç–∏ –ø—Ä–æ–±–ª–µ–º –∑ —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥–æ–º –∫–Ω–æ–ø–∫–∏
            displayProducts(allProducts); 
            
            // –û–Ω–æ–≤–ª—é—î–º–æ –∫–Ω–æ–ø–∫—É –≤ –º–æ–¥–∞–ª—å–Ω–æ–º—É –≤—ñ–∫–Ω—ñ, —è–∫—â–æ –≤–æ–Ω–æ –≤—ñ–¥–∫—Ä–∏—Ç–µ
            if (currentProductInDetail && currentProductInDetail.id === productId) {
                document.getElementById('detail-add-to-cart-btn').textContent = `–î–æ–¥–∞–Ω–æ –¥–æ –∫–æ—à–∏–∫–∞ (${cart[productId].qty})`;
            }
            
            updateMainButton();
        }

        function updateCartQty(productId, delta) {
            if (!cart[productId]) return;

            cart[productId].qty += delta;

            if (cart[productId].qty <= 0) {
                delete cart[productId];
            }
            
            saveCart();
            
            if (currentView === 'cart') {
                renderCart();
            } else {
                displayProducts(allProducts); // –ü–æ–≤–Ω–µ –æ–Ω–æ–≤–ª–µ–Ω–Ω—è –¥–ª—è –∫–æ—Ä–µ–∫—Ç–Ω–æ–≥–æ –≤—ñ–¥–æ–±—Ä–∞–∂–µ–Ω–Ω—è
            }
            updateMainButton();
        }
        
        function saveCart() {
            localStorage.setItem('telegramStoreCart', JSON.stringify(cart));
        }

        function getCartTotal() {
            let total = 0;
            let count = 0;
            for (const id in cart) {
                if (cart[id].qty > 0) {
                    total += cart[id].qty * cart[id].price;
                    count += cart[id].qty;
                }
            }
            return { total: total, count: count };
        }
        
        // --- 6. –ö–ï–†–£–í–ê–ù–ù–Ø –ö–ù–û–ü–ö–û–Æ –¢–ï–õ–ï–ì–†–ê–ú ---
        
        function updateMainButton() {
            const { total, count } = getCartTotal();
            const totalFormatted = total.toFixed(2) + ' –≥—Ä–Ω.';
            
            if (currentView === 'catalog' && count > 0) {
                WebApp.MainButton.setText(`–ü–µ—Ä–µ–π—Ç–∏ –¥–æ –∫–æ—à–∏–∫–∞ (${count} —à—Ç. | ${totalFormatted})`);
                WebApp.MainButton.enable();
            } else if (currentView === 'catalog' && count === 0) {
                 WebApp.MainButton.setText(`–ö–æ—à–∏–∫ –ø–æ—Ä–æ–∂–Ω—ñ–π`);
                 WebApp.MainButton.disable();
            } else if (currentView === 'cart' && count > 0) {
                WebApp.MainButton.setText(`–û—Ñ–æ—Ä–º–∏—Ç–∏ –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è (${totalFormatted})`);
                WebApp.MainButton.enable();
            } else { // –ö–æ—à–∏–∫ –ø–æ—Ä–æ–∂–Ω—ñ–π –Ω–∞ —Å—Ç–æ—Ä—ñ–Ω—Ü—ñ –∫–æ—à–∏–∫–∞
                WebApp.MainButton.setText(`–ü–æ–≤–µ—Ä–Ω—É—Ç–∏—Å—è –¥–æ –∫–∞—Ç–∞–ª–æ–≥—É`);
                WebApp.MainButton.enable();
            }
            WebApp.MainButton.setParams({color: '#FF69B4'}); // –ó–∞–¥–∞—î–º–æ —Ä–æ–∂–µ–≤–∏–π –∫–æ–ª—ñ—Ä –∫–Ω–æ–ø—Ü—ñ Telegram
        }
        
        function handleMainButtonClick() {
            if (currentView === 'catalog') {
                if (getCartTotal().count > 0) {
                    // –ü–µ—Ä–µ—Ö—ñ–¥ —É –∫–æ—à–∏–∫
                    currentView = 'cart';
                    document.getElementById('catalog-view').style.display = 'none';
                    document.getElementById('cart-view').style.display = 'block';
                    WebApp.BackButton.show(); 
                    renderCart();
                    updateMainButton();
                }
            } else if (currentView === 'cart') {
                if (getCartTotal().count > 0) {
                    placeOrder();
                } else {
                    // –ü–æ–≤–µ—Ä–Ω—É—Ç–∏—Å—è –≤ –∫–∞—Ç–∞–ª–æ–≥, —è–∫—â–æ –∫–æ—à–∏–∫ –ø–æ—Ä–æ–∂–Ω—ñ–π
                    handleBackButtonClick();¬†
                }
            }
        }
        
        // –í–ò–ü–†–ê–í–õ–ï–ù–û: –û–±—Ä–æ–±–Ω–∏–∫ –∫–Ω–æ–ø–∫–∏ "–ù–∞–∑–∞–¥"
        function handleBackButtonClick() {
             // –°–ø–æ—á–∞—Ç–∫—É –ø–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ, —á–∏ –≤—ñ–¥–∫—Ä–∏—Ç–µ –º–æ–¥–∞–ª—å–Ω–µ –≤—ñ–∫–Ω–æ
             if (document.getElementById('product-detail-modal').style.display === 'block') {
                 closeProductDetail();
                 return;
             }
            
             // –õ–æ–≥—ñ–∫–∞ –ø–µ—Ä–µ—Ö–æ–¥—É –ö–æ—à–∏–∫ -> –ö–∞—Ç–∞–ª–æ–≥
             if (currentView === 'cart') {
                currentView = 'catalog';
                document.getElementById('catalog-view').style.display = 'block';
                document.getElementById('cart-view').style.display = 'none';
                WebApp.BackButton.hide(); 
                // –ù–µ –≤–∏–∫–ª–∏–∫–∞—î–º–æ displayProducts —Ç—É—Ç, –æ—Å–∫—ñ–ª—å–∫–∏ —Ü–µ –≤—ñ–¥–±—É–≤–∞—î—Ç—å—Å—è –≤ updateCartQty,
                // –∞–ª–µ –≤–∏–∫–ª–∏–∫–∞—î–º–æ updateMainButton –¥–ª—è –æ–Ω–æ–≤–ª–µ–Ω–Ω—è —Ç–µ–∫—Å—Ç—É
                updateMainButton(); 
            }
        }
        
        // --- 7. –í–Ü–î–ü–†–ê–í–ö–ê –ó–ê–ú–û–í–õ–ï–ù–ù–Ø –Ü –ó–ë–ï–†–ï–ñ–ï–ù–ù–Ø –í DB ---
        
        async function placeOrder() {
            const { total, count } = getCartTotal();
            const contactName = document.getElementById('contact-name').value;
            const address = document.getElementById('delivery-address').value;

            if (!contactName || !address) {
                WebApp.showAlert('–ë—É–¥—å –ª–∞—Å–∫–∞, –∑–∞–ø–æ–≤–Ω—ñ—Ç—å –Ü–º\'—è —Ç–∞ –ê–¥—Ä–µ—Å—É –¥–æ—Å—Ç–∞–≤–∫–∏.');
                return;
            }
            
            WebApp.MainButton.showProgress(true); 
            
            const orderDetails = {
                items: Object.values(cart).filter(item => item.qty > 0),
                totalPrice: total,
                totalCount: count,
                contactName: contactName,
                address: address,
                telegramUserId: WebApp.initDataUnsafe.user ? WebApp.initDataUnsafe.user.id : 'unknown',
                telegramUserName: WebApp.initDataUnsafe.user ? WebApp.initDataUnsafe.user.username : 'n/a'
            };

            try {
                // 1. –í—ñ–¥–ø—Ä–∞–≤–∫–∞ –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è –Ω–∞ –≤–∞—à Flask-—Å–µ—Ä–≤–µ—Ä –¥–ª—è –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è –≤ Firestore
                const dbResponse = await fetch(API_URL_ORDER, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(orderDetails)
                });

                if (!dbResponse.ok) {
                    throw new Error(`–ü–æ–º–∏–ª–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞ (${dbResponse.status}) –ø—Ä–∏ –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—ñ –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è.`);
                }
                
                // 2. –ü—ñ—Å–ª—è —É—Å–ø—ñ—à–Ω–æ–≥–æ –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è –≤ Firestore, –≤—ñ–¥–ø—Ä–∞–≤–ª—è—î–º–æ –¥–∞–Ω—ñ –±–æ—Ç—É
                const dataToSend = JSON.stringify(orderDetails);
                WebApp.sendData(dataToSend);

                // –°–ø–æ–≤—ñ—â–µ–Ω–Ω—è, –æ—á–∏—â–µ–Ω–Ω—è —Ç–∞ –∑–∞–∫—Ä–∏—Ç—Ç—è
                WebApp.showAlert('‚úÖ –í–∞—à–µ –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è –ø—Ä–∏–π–Ω—è—Ç–æ! –ë–æ—Ç —Å–∫–æ—Ä–æ –≤—ñ–¥–ø–æ–≤—ñ—Å—Ç—å.', () => {
                    localStorage.removeItem('telegramStoreCart'); // –û—á–∏—â—É—î–º–æ –∫–æ—à–∏–∫
                    WebApp.close(); // –ó–∞–∫—Ä–∏–≤–∞—î–º–æ Web App
                });

            } catch (error) {
                console.error("–ü–æ–º–∏–ª–∫–∞ –ø—Ä–∏ –æ—Ñ–æ—Ä–º–ª–µ–Ω–Ω—ñ –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è:", error);
                WebApp.showAlert('‚ùå –ù–µ –≤–¥–∞–ª–æ—Å—è –æ—Ñ–æ—Ä–º–∏—Ç–∏ –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è. –ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ –ø—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è –¥–æ —Å–µ—Ä–≤–µ—Ä–∞ –∞–±–æ –¥–∞–Ω—ñ.');
            } finally {
                WebApp.MainButton.hideProgress(); 
            }
        }

        // --- –Ü–ù–Ü–¶–Ü–ê–õ–Ü–ó–ê–¶–Ü–Ø ---
        initApp();
    </script>
</body>
</html>